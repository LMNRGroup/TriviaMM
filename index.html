<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TriviaApp - Big Screen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --navy:#0A192F;
      --gold:#D4AF37;
      --danger:#F97373;
      --success:#10B981;
      --muted:#9CA3AF;
      --panel:#020b1b;
      --panel2:#020617;
      --border:rgba(212,175,55,0.35);
      --text:#F4F4F4;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      color: var(--text);
      background: var(--navy);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
      background: radial-gradient(circle at top, #0f172a, var(--navy));
      overflow-x:hidden;
    }
    .stage{
      width:1920px;
      height:1080px;
      max-width:100%;
      aspect-ratio: 16/9;
      background: rgba(2,11,27,0.96);
      border-radius: 22px;
      border: 1px solid rgba(15, 23, 42, 0.9);
      box-shadow: 0 18px 45px rgba(0,0,0,0.7);
      padding:18px;
      display:flex;
      flex-direction:column;
      gap:14px;
      overflow:hidden;
    }

    /* Top header bar (same vibe as your admin UI) */
    .header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:10px 18px;
      border-radius:999px;
      background: var(--panel);
      border: 1px solid var(--border);
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    .header-left, .header-right{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .brand{
      font-size:18px;
      letter-spacing:0.20em;
      text-transform:uppercase;
      color: var(--gold);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pill{
      font-size:12px;
      padding:7px 14px;
      border-radius:999px;
      border:1px solid rgba(212,175,55,0.55);
      background: rgba(10,25,47,0.9);
      color: var(--text);
      letter-spacing:0.14em;
      text-transform:uppercase;
      white-space:nowrap;
    }
    .pill.bad{ border-color: var(--danger); color:#fecaca; }
    .pill.good{ border-color: rgba(16,185,129,0.9); color:#a7f3d0; }

    .main{
      flex:1;
      display:grid;
      grid-template-columns: 280px minmax(0, 1fr) 320px;
      gap:16px;
      min-height:0;
    }

    .side{
      background: radial-gradient(circle at top, var(--panel2), var(--panel));
      border-radius:16px;
      border: 1px solid rgba(31,41,55,0.9);
      padding:14px 14px 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:0;
    }
    .side-title{
      font-size:13px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color: var(--gold);
      margin-bottom:4px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .metric{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(55,65,81,0.85);
      background: rgba(2,6,23,0.55);
    }
    .metric .k{
      font-size:11px;
      letter-spacing:0.14em;
      text-transform:uppercase;
      color: var(--muted);
      white-space:nowrap;
    }
    .metric .v{
      font-size:18px;
      letter-spacing:0.06em;
      color: var(--text);
      white-space:nowrap;
    }
    .timerbar{
      height:10px;
      border-radius:999px;
      background: rgba(148,163,184,0.25);
      overflow:hidden;
      border:1px solid rgba(55,65,81,0.65);
    }
    .timerfill{
      height:100%;
      width:100%;
      background: linear-gradient(to right, var(--gold), #f9fafb);
      transform-origin:left center;
      transform: scaleX(1);
      transition: transform 0.1s linear;
    }

    .center{
      background: rgba(2,6,23,0.55);
      border-radius:18px;
      border: 1px solid rgba(55,65,81,0.75);
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:14px;
      min-height:0;
    }
    .questionTop{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:12px;
    }
    .qLabel{
      font-size:14px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      color: var(--gold);
      white-space:nowrap;
    }
    .qText{
      margin-top:4px;
      font-size:40px;
      line-height:1.08;
      font-weight:700;
      letter-spacing:-0.01em;
      color: var(--text);
      word-wrap:break-word;
      overflow-wrap:anywhere;
    }

    .choices{
      margin-top:6px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      min-height:0;
    }
    .choice{
      border-radius:18px;
      border:1px solid rgba(55,65,81,0.9);
      background: rgba(2,6,23,0.75);
      padding:16px 16px;
      min-height:118px;
      display:flex;
      gap:12px;
      align-items:flex-start;
      box-shadow: 0 10px 26px rgba(0,0,0,0.35);
      transition: transform 0.12s ease, filter 0.12s ease, border-color 0.12s ease;
    }
    .choiceKey{
      width:46px;
      height:46px;
      border-radius:14px;
      display:flex;
      align-items:center;
      justify-content:center;
      border:1px solid rgba(212,175,55,0.55);
      background: rgba(10,25,47,0.85);
      color: var(--gold);
      font-weight:800;
      font-size:18px;
      flex:0 0 auto;
    }
    .choiceText{
      font-size:22px;
      line-height:1.15;
      color: var(--text);
      word-wrap:break-word;
      overflow-wrap:anywhere;
    }
    .choice.correct{
      border-color: rgba(16,185,129,0.95);
      box-shadow: 0 0 0 2px rgba(16,185,129,0.25), 0 18px 45px rgba(0,0,0,0.55);
    }
    .choice.correct .choiceKey{
      border-color: rgba(16,185,129,0.95);
      color:#a7f3d0;
    }
    .choice.wrong{
      border-color: rgba(249,115,115,0.95);
      box-shadow: 0 0 0 2px rgba(249,115,115,0.18), 0 18px 45px rgba(0,0,0,0.55);
    }
    .choice.wrong .choiceKey{
      border-color: rgba(249,115,115,0.95);
      color:#fecaca;
    }

    .splash{
      height:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      gap:14px;
      padding:20px;
    }
    .splashTitle{
      font-size:56px;
      font-weight:900;
      letter-spacing:0.12em;
      text-transform:uppercase;
      color: var(--gold);
      margin:0;
    }
    .splashSub{
      font-size:18px;
      color: var(--muted);
      margin:0;
      max-width:900px;
    }
    .splashHint{
      margin-top:12px;
      font-size:13px;
      letter-spacing:0.14em;
      text-transform:uppercase;
      color:#e5e7eb;
      opacity:0.9;
    }

    .bigScore{
      font-size:92px;
      font-weight:900;
      letter-spacing:0.06em;
      color: var(--text);
      margin:0;
    }
    .finalLabel{
      font-size:14px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color: var(--gold);
      margin:0;
    }

    /* Keep no horizontal overflow at any size */
    @media (max-width: 1100px){
      .main{ grid-template-columns: 240px minmax(0,1fr) 260px; }
      .qText{ font-size:34px; }
      .choiceText{ font-size:18px; }
    }
    @media (max-width: 900px){
      body{ padding:10px; }
      .stage{ padding:12px; }
      .main{ grid-template-columns: 1fr; grid-template-rows:auto 1fr auto; }
      .qText{ font-size:28px; }
      .choices{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <div class="stage" id="stage">
    <div class="header">
      <div class="header-left">
        <div class="brand">LUMinar Apps · Trivia</div>
      </div>
      <div class="header-right">
        <div id="pill" class="pill">SERVER: LOADING…</div>
      </div>
    </div>

    <div class="main">
      <!-- Left -->
      <aside class="side">
        <div class="side-title">Game</div>
        <div class="metric">
          <div class="k">Question</div>
          <div class="v" id="mQ">—</div>
        </div>
        <div class="metric">
          <div class="k">Score</div>
          <div class="v" id="mS">0</div>
        </div>
        <div class="side-title" style="margin-top:6px;">Timer</div>
        <div class="timerbar"><div id="timerFill" class="timerfill"></div></div>
        <div class="metric">
          <div class="k">Seconds left</div>
          <div class="v" id="mT">—</div>
        </div>
        <div class="metric">
          <div class="k">Status</div>
          <div class="v" id="mStatus">WAITING</div>
        </div>
      </aside>

      <!-- Center -->
      <section class="center" id="center">
        <!-- Splash by default -->
        <div class="splash" id="splash">
          <h1 class="splashTitle">Trivia</h1>
          <p class="splashSub">
            One guest at a time. Host enters the master code on the phone to start.
          </p>
          <div class="splashHint">Waiting for host…</div>
        </div>

        <!-- Live question -->
        <div id="live" style="display:none;">
          <div class="questionTop">
            <div class="qLabel" id="qLabel">QUESTION 1 / 20</div>
            <div class="pill good" id="livePill">LIVE</div>
          </div>
          <div class="qText" id="qText">—</div>

          <div class="choices" id="choices">
            <div class="choice" id="cA"><div class="choiceKey">A</div><div class="choiceText" id="tA">—</div></div>
            <div class="choice" id="cB"><div class="choiceKey">B</div><div class="choiceText" id="tB">—</div></div>
            <div class="choice" id="cC"><div class="choiceKey">C</div><div class="choiceText" id="tC">—</div></div>
            <div class="choice" id="cD"><div class="choiceKey">D</div><div class="choiceText" id="tD">—</div></div>
          </div>
        </div>

        <!-- Final -->
        <div class="splash" id="final" style="display:none;">
          <div class="finalLabel">Final score</div>
          <h2 class="bigScore" id="finalScore">0 / 20</h2>
          <div class="splashSub">Returning to splash for next guest…</div>
        </div>
      </section>

      <!-- Right -->
      <aside class="side">
        <div class="side-title">Notes</div>
        <div style="font-size:12px;color:var(--muted);line-height:1.5;">
          • Phone controls the game<br/>
          • 30 seconds per question<br/>
          • Correct +1, incorrect +0<br/>
          • Auto-advance on answer or timeout
        </div>
        <div class="side-title" style="margin-top:8px;">Event</div>
        <div style="font-size:12px;color:#e5e7eb;opacity:0.9;line-height:1.55;">
          This screen never shows any join code.<br/>
          Host starts each guest using the master passkey.
        </div>
      </aside>
    </div>
  </div>

<script>
/**
 * SINGLE-CODE MODE:
 * - We use one fixed room code in KV (no public join code displayed)
 * - The ONLY "secret" is APP_PK typed on phone.
 */
const ROOM_CODE = "ACTIVE";         // fixed key in KV (we’ll adjust backend to use this)
const TOTAL = 20;
const QUESTION_SECONDS = 30;

const QUESTIONS = [
  { q:"What color is Luminar’s primary accent?", a:{A:"Gold",B:"Purple",C:"Orange",D:"Pink"}, correct:"A" },
  { q:"How many choices per question?", a:{A:"2",B:"3",C:"4",D:"5"}, correct:"C" },
  { q:"Score for a correct answer?", a:{A:"+2",B:"+1",C:"+0.5",D:"-1"}, correct:"B" },
  { q:"Timer per question is…", a:{A:"10s",B:"20s",C:"30s",D:"60s"}, correct:"C" },
  { q:"Puerto Rico is an island in the…", a:{A:"Pacific",B:"Atlantic",C:"Indian",D:"Arctic"}, correct:"B" },
  { q:"HTML stands for…", a:{A:"HyperText Markup Language",B:"HighText Markdown List",C:"Hyper Transfer Markup Link",D:"Home Tool Markup Language"}, correct:"A" },
  { q:"CSS is mainly used for…", a:{A:"Database",B:"Styling",C:"Email",D:"Compiling"}, correct:"B" },
  { q:"Vercel KV is based on…", a:{A:"Redis",B:"MySQL",C:"MongoDB",D:"SQLite"}, correct:"A" },
  { q:"A hex color starts with…", a:{A:"@",B:"#",C:"$",D:"&"}, correct:"B" },
  { q:"Which is a JavaScript primitive?", a:{A:"Array",B:"Object",C:"String",D:"Date"}, correct:"C" },
  { q:"HTTP status for success is…", a:{A:"200",B:"404",C:"500",D:"301"}, correct:"A" },
  { q:"Which is NOT a browser?", a:{A:"Chrome",B:"Safari",C:"Firefox",D:"Node"}, correct:"D" },
  { q:"RGB has how many channels?", a:{A:"1",B:"2",C:"3",D:"4"}, correct:"C" },
  { q:"A URL usually starts with…", a:{A:"ftp://",B:"http://",C:"zip://",D:"raw://"}, correct:"B" },
  { q:"Which is a correct JSON value?", a:{A:"undefined",B:"function()",C:"null",D:"NaN"}, correct:"C" },
  { q:"LocalStorage stores data…", a:{A:"On server",B:"In memory only",C:"In browser",D:"In DNS"}, correct:"C" },
  { q:"Max score in this game is…", a:{A:"10",B:"15",C:"20",D:"25"}, correct:"C" },
  { q:"If time runs out, score change is…", a:{A:"+1",B:"+0",C:"-1",D:"+2"}, correct:"B" },
  { q:"Correct answers highlight…", a:{A:"Red",B:"Blue",C:"Green",D:"Gray"}, correct:"C" },
  { q:"This app avoids realtime providers using…", a:{A:"WebSockets",B:"Polling",C:"Bluetooth",D:"SMS"}, correct:"B" }
];

const elPill = document.getElementById("pill");
const mQ = document.getElementById("mQ");
const mS = document.getElementById("mS");
const mT = document.getElementById("mT");
const mStatus = document.getElementById("mStatus");
const timerFill = document.getElementById("timerFill");

const splash = document.getElementById("splash");
const live = document.getElementById("live");
const final = document.getElementById("final");

const qLabel = document.getElementById("qLabel");
const qText = document.getElementById("qText");
const tA = document.getElementById("tA");
const tB = document.getElementById("tB");
const tC = document.getElementById("tC");
const tD = document.getElementById("tD");
const cA = document.getElementById("cA");
const cB = document.getElementById("cB");
const cC = document.getElementById("cC");
const cD = document.getElementById("cD");
const finalScore = document.getElementById("finalScore");

let hostToken = localStorage.getItem("trivia_hostToken") || "";
let state = {
  phase: "splash",
  total: TOTAL,
  qIndex: 0,
  score: 0,
  questionEndsAt: null
};

let pollTimer = null;
let tickTimer = null;
let lastSeq = 0;
let locked = false; // prevent double-advance

function setPill(text, mode){
  elPill.textContent = text;
  elPill.classList.remove("bad","good");
  if (mode) elPill.classList.add(mode);
}

function setView(which){
  splash.style.display = which === "splash" ? "flex" : "none";
  live.style.display   = which === "live"   ? "block" : "none";
  final.style.display  = which === "final"  ? "flex" : "none";
}

function clearHighlights(){
  [cA,cB,cC,cD].forEach(el=>{
    el.classList.remove("correct","wrong");
  });
}

function renderQuestion(){
  const q = QUESTIONS[state.qIndex];
  qLabel.textContent = `QUESTION ${state.qIndex+1} / ${TOTAL}`;
  qText.textContent = q.q;
  tA.textContent = q.a.A;
  tB.textContent = q.a.B;
  tC.textContent = q.a.C;
  tD.textContent = q.a.D;

  mQ.textContent = `${state.qIndex+1}/${TOTAL}`;
  mS.textContent = `${state.score}`;
  mStatus.textContent = "LIVE";
  clearHighlights();
}

async function hostPush(){
  if (!hostToken) return;
  try{
    await fetch("/api/host-state",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        roomCode: ROOM_CODE,
        hostToken,
        state
      })
    });
  }catch(_){}
}

async function ensureRoom(){
  // We create/ensure the fixed room "ACTIVE" and keep a hostToken.
  setPill("SERVER: CONNECTING…");
  try{
    const res = await fetch("/api/create-room",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ roomCode: ROOM_CODE }) // backend will be updated to honor this
    });
    const data = await res.json().catch(()=> ({}));
    if (!res.ok || !data.ok) throw new Error(data.error || "create_room_failed");

    // Expect backend to return hostToken (roomCode fixed)
    hostToken = data.hostToken || hostToken;
    localStorage.setItem("trivia_hostToken", hostToken);

    setPill("SERVER: READY", "good");
    await hostPush();
  }catch(err){
    console.error(err);
    setPill("SERVER: ERROR", "bad");
  }
}

function startNewRound(){
  locked = false;
  lastSeq = 0;
  state.phase = "live";
  state.qIndex = 0;
  state.score = 0;
  state.questionEndsAt = Date.now() + QUESTION_SECONDS*1000;
  setView("live");
  renderQuestion();
  hostPush();
}

function endRound(){
  state.phase = "finished";
  state.questionEndsAt = null;
  hostPush();
  setView("final");
  finalScore.textContent = `${state.score} / ${TOTAL}`;
  mStatus.textContent = "DONE";
  mT.textContent = "—";
  timerFill.style.transform = "scaleX(0)";

  // Reset after a short beat
  setTimeout(async ()=>{
    await resetToSplash();
  }, 3500);
}

async function resetToSplash(){
  // Critical: release controller + clear last answer
  state = { phase:"reset", total:TOTAL, qIndex:0, score:0, questionEndsAt:null, reset:true };
  await hostPush();

  // Now go to splash
  state = { phase:"splash", total:TOTAL, qIndex:0, score:0, questionEndsAt:null };
  await hostPush();
  setView("splash");
  mQ.textContent = "—";
  mS.textContent = "0";
  mT.textContent = "—";
  mStatus.textContent = "WAITING";
  clearHighlights();
  locked = false;
  lastSeq = 0;
}

function applyAnswer(choice){
  const q = QUESTIONS[state.qIndex];
  const isCorrect = (choice === q.correct);

  // highlight
  const map = {A:cA,B:cB,C:cC,D:cD};
  const chosenEl = map[choice];
  if (chosenEl){
    chosenEl.classList.add(isCorrect ? "correct" : "wrong");
  }

  if (isCorrect) state.score += 1;
  mS.textContent = `${state.score}`;

  // advance immediately (tiny delay so people see the flash)
  setTimeout(()=> advance(), 450);
}

function timeoutAnswer(){
  // No selection, just advance
  setTimeout(()=> advance(), 150);
}

function advance(){
  if (locked) return;
  locked = true;

  if (state.qIndex >= TOTAL-1){
    endRound();
    return;
  }

  state.qIndex += 1;
  state.phase = "live";
  state.questionEndsAt = Date.now() + QUESTION_SECONDS*1000;
  locked = false;
  clearHighlights();
  renderQuestion();
  hostPush();
}

async function pollAnswersLoop(){
  if (!hostToken) return;

  try{
    const url = `/api/poll-answer?roomCode=${encodeURIComponent(ROOM_CODE)}&hostToken=${encodeURIComponent(hostToken)}&afterSeq=${encodeURIComponent(lastSeq)}`;
    const res = await fetch(url);
    const data = await res.json().catch(()=> ({}));
    if (res.ok && data.ok){
      if (typeof data.seq === "number") lastSeq = data.seq;
      if (data.answer && state.phase === "live" && !locked){
        applyAnswer(String(data.answer.choice || "").toUpperCase());
      }
    }
  }catch(_){}
}

function tick(){
  if (state.phase !== "live" || !state.questionEndsAt){
    mT.textContent = "—";
    timerFill.style.transform = "scaleX(0)";
    return;
  }
  const msLeft = state.questionEndsAt - Date.now();
  const sLeft = Math.max(0, Math.ceil(msLeft/1000));
  mT.textContent = `${sLeft}`;

  const pct = Math.max(0, Math.min(1, msLeft/(QUESTION_SECONDS*1000)));
  timerFill.style.transform = `scaleX(${pct})`;

  if (msLeft <= 0 && !locked){
    locked = true;
    // treat as incorrect +0
    timeoutAnswer();
    // also push state so phone sees move
    hostPush();
  }
}

async function bootstrap(){
  setView("splash");
  mStatus.textContent = "WAITING";
  await ensureRoom();

  // Always keep a snapshot even on splash
  await hostPush();

  // Start poll/tick loops
  pollTimer = setInterval(pollAnswersLoop, 350);
  tickTimer = setInterval(tick, 100);

  // Auto-start when controller joins:
  // We’ll simply watch for controller existence by probing get-state from host side? No.
  // Instead: host starts game automatically when it receives the first answer OR after controller joins
  // For simplicity: start game on first answer received while on splash.
  // We'll also allow manual start: press Space.
  window.addEventListener("keydown",(e)=>{
    if (e.code === "Space"){
      e.preventDefault();
      if (state.phase === "splash") startNewRound();
    }
  });

  // If first answer arrives while on splash, start automatically (handled inside poll loop by checking phase).
  const originalPoll = pollAnswersLoop;
  pollAnswersLoop = async function(){
    if (!hostToken) return;
    try{
      const url = `/api/poll-answer?roomCode=${encodeURIComponent(ROOM_CODE)}&hostToken=${encodeURIComponent(hostToken)}&afterSeq=${encodeURIComponent(lastSeq)}`;
      const res = await fetch(url);
      const data = await res.json().catch(()=> ({}));
      if (res.ok && data.ok){
        if (typeof data.seq === "number") lastSeq = data.seq;
        if (data.answer){
          // If splash and controller sends something (or any ping), begin round
          if (state.phase === "splash"){
            startNewRound();
            // after start, apply answer to Q1
            applyAnswer(String(data.answer.choice || "").toUpperCase());
            return;
          }
          if (state.phase === "live" && !locked){
            applyAnswer(String(data.answer.choice || "").toUpperCase());
          }
        }
      }
    }catch(_){}
  };
  clearInterval(pollTimer);
  pollTimer = setInterval(pollAnswersLoop, 350);
}

bootstrap();
</script>
</body>
</html>
