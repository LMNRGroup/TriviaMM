<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TriviaApp - Big Screen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --navy:#0A192F;
      --gold:#D4AF37;
      --danger:#F97373;
      --success:#10B981;
      --muted:#9CA3AF;
      --panel:#020b1b;
      --panel2:#020617;
      --border:rgba(212,175,55,0.35);
      --text:#F4F4F4;

      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      color: var(--text);
      background: var(--navy);
    }
    *{ box-sizing:border-box; }

    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
      background:
        radial-gradient(circle at top, rgba(212,175,55,0.10), transparent 45%),
        radial-gradient(circle at 20% 20%, rgba(16,185,129,0.08), transparent 40%),
        radial-gradient(circle at top, #0f172a, var(--navy));
      overflow:hidden; /* no horizontal scroll ever */
    }

/* =========================
   STAGE + NYE STACKING
   (deterministic z-index)
   ========================= */

/* 1920x1080 stage (scales to fit viewport) */
.stage{
  isolation:isolate;
  width: min(1920px, 100%);
  aspect-ratio: 16 / 9;
  max-height: calc(100vh - 48px);
  height: auto;
  background: rgba(2,11,27,0.96);
  border-radius: 22px;
  border: 1px solid rgba(15, 23, 42, 0.9);
  box-shadow: 0 18px 45px rgba(0,0,0,0.7);
  position:relative;
  overflow:hidden;
  display:flex;
}

/* NYE background behind everything */
.nyeBg{
  position:absolute;
  inset:0;
  z-index:0;
  pointer-events:none;
  overflow:hidden;
}

/* Put all UI above NYE background */
.splash, .liveWrap, .overlay, .final, .legalFooter{
  position: relative;
  z-index: 2;
}

/* Subtle moving shine (above bg, below UI) */
.stage::before{
  content:"";
  position:absolute;
  inset:-30%;
  z-index:1;
  background:
    radial-gradient(circle at 30% 20%, rgba(212,175,55,0.12), transparent 46%),
    radial-gradient(circle at 70% 60%, rgba(16,185,129,0.08), transparent 52%);
  animation: drift 10s ease-in-out infinite;
  pointer-events:none;
  mix-blend-mode: screen;
  opacity:0.9;
}

@keyframes drift{
  0%,100%{ transform: translate(0,0) rotate(0deg); }
  50%{ transform: translate(4%, -2%) rotate(2deg); }
}

/* =========================
   NYE ANIMATED BACKGROUND
   ========================= */

/* Base subtle color wash */
.nyeBg::before{
  content:"";
  position:absolute;
  inset:-10%;
  background:
    radial-gradient(circle at 18% 22%, rgba(212,175,55,0.18), transparent 42%),
    radial-gradient(circle at 80% 28%, rgba(236,72,153,0.10), transparent 40%),
    radial-gradient(circle at 50% 75%, rgba(34,211,238,0.08), transparent 45%),
    radial-gradient(circle at 60% 10%, rgba(16,185,129,0.06), transparent 45%);
  filter: blur(0.5px);
  opacity: 0.9;
}

/* layers */
.nyeLayer{
  position:absolute;
  inset:-30%;
  opacity:0.92;
  mix-blend-mode: screen;
  transform: translateZ(0);
  will-change: transform, opacity;
}

/* 1) Sparkle dust / stars */
.nyeLayer.sparkles{
  background:
    radial-gradient(circle at 10% 20%, rgba(255,255,255,0.75) 0 1px, transparent 2px),
    radial-gradient(circle at 25% 65%, rgba(255,255,255,0.55) 0 1px, transparent 2px),
    radial-gradient(circle at 40% 35%, rgba(255,255,255,0.60) 0 1px, transparent 2px),
    radial-gradient(circle at 55% 15%, rgba(255,255,255,0.50) 0 1px, transparent 2px),
    radial-gradient(circle at 72% 52%, rgba(255,255,255,0.65) 0 1px, transparent 2px),
    radial-gradient(circle at 85% 30%, rgba(255,255,255,0.50) 0 1px, transparent 2px),
    radial-gradient(circle at 90% 78%, rgba(255,255,255,0.55) 0 1px, transparent 2px);
  filter: drop-shadow(0 0 8px rgba(255,255,255,0.10));
  animation: nyeTwinkle 3.2s ease-in-out infinite;
  opacity:0.62;
}

@keyframes nyeTwinkle{
  0%,100%{ opacity:0.40; transform: translate(0,0) scale(1); }
  50%{ opacity:0.85; transform: translate(1.2%, -0.8%) scale(1.02); }
}

/* 2) Big bokeh orbs */
.nyeLayer.bokeh{
  background:
    radial-gradient(circle at 12% 30%, rgba(212,175,55,0.22) 0 140px, transparent 160px),
    radial-gradient(circle at 35% 78%, rgba(236,72,153,0.16) 0 180px, transparent 210px),
    radial-gradient(circle at 78% 18%, rgba(34,211,238,0.14) 0 200px, transparent 240px),
    radial-gradient(circle at 86% 72%, rgba(16,185,129,0.10) 0 170px, transparent 210px),
    radial-gradient(circle at 52% 42%, rgba(255,255,255,0.06) 0 240px, transparent 300px);
  filter: blur(6px);
  opacity:0.52;
  animation: nyeFloat 12s ease-in-out infinite;
}

@keyframes nyeFloat{
  0%,100%{ transform: translate(0,0) scale(1); }
  50%{ transform: translate(-1.8%, 1.4%) scale(1.03); }
}

/* 3) “Fireworks” rings (CSS-only bursts) */
.nyeLayer.fireworks{
  opacity:0.52;
  background:
    radial-gradient(circle at 18% 22%, transparent 0 34px, rgba(212,175,55,0.25) 35px 36px, transparent 37px 999px),
    radial-gradient(circle at 18% 22%, transparent 0 66px, rgba(255,255,255,0.12) 67px 68px, transparent 69px 999px),

    radial-gradient(circle at 78% 28%, transparent 0 30px, rgba(236,72,153,0.22) 31px 32px, transparent 33px 999px),
    radial-gradient(circle at 78% 28%, transparent 0 64px, rgba(255,255,255,0.10) 65px 66px, transparent 67px 999px),

    radial-gradient(circle at 58% 68%, transparent 0 34px, rgba(34,211,238,0.20) 35px 36px, transparent 37px 999px),
    radial-gradient(circle at 58% 68%, transparent 0 72px, rgba(255,255,255,0.10) 73px 74px, transparent 75px 999px);
  filter: blur(0.8px);
  animation: nyeBursts 4.6s ease-in-out infinite;
}

@keyframes nyeBursts{
  0%{ transform: scale(0.92) translateY(0); opacity:0.30; }
  35%{ transform: scale(1.04) translateY(-0.6%); opacity:0.70; }
  70%{ transform: scale(1.10) translateY(-1.2%); opacity:0.40; }
  100%{ transform: scale(0.92) translateY(0); opacity:0.30; }
}

/* 4) Confetti “streams” (diagonal dashes) */
.nyeLayer.confetti{
  opacity:0.33;
  background:
    repeating-linear-gradient(
      125deg,
      rgba(212,175,55,0.00) 0 24px,
      rgba(212,175,55,0.22) 24px 26px,
      rgba(236,72,153,0.18) 26px 28px,
      rgba(34,211,238,0.14) 28px 30px,
      rgba(255,255,255,0.10) 30px 31px,
      rgba(212,175,55,0.00) 31px 58px
    );
  filter: blur(0.4px);
  animation: nyeConfetti 9s linear infinite;
}

@keyframes nyeConfetti{
  0%{ transform: translate(-6%, -6%); }
  100%{ transform: translate(6%, 6%); }
}

/* Vignette so center content stays readable */
.nyeVignette{
  position:absolute;
  inset:0;
  background:
    radial-gradient(circle at center, rgba(2,11,27,0.00) 0 40%, rgba(2,11,27,0.55) 75% 100%);
  opacity:0.95;
}

/* Respect reduced motion */
@media (prefers-reduced-motion: reduce){
  .stage::before{ animation:none !important; }
  .nyeLayer{ animation:none !important; }
}

    /* ===== SPLASH ===== */
    .splash{
      position:absolute;
      inset:0;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding:72px 90px;
      gap:18px;
      z-index:2;
    }

    .splashLogo{
      width:min(520px, 56%);
      height:auto;
      display:block;
      object-fit:contain;
      filter: drop-shadow(0 18px 45px rgba(0,0,0,0.55));
      user-select:none;
      -webkit-user-drag:none;
      pointer-events:none;
      margin-bottom:4px;
    }

    /* “TRIVIA” casino/TV pop */
    .logoText{
      font-size:106px;
      font-weight:1000;
      letter-spacing:0.22em;
      text-transform:uppercase;
      color: var(--gold);
      margin:0;
      line-height:1.0;
      text-shadow:
        0 0 26px rgba(212,175,55,0.22),
        0 18px 55px rgba(0,0,0,0.70);
      position:relative;
      transform: translateZ(0);
      animation: triviaPop 1.35s ease-in-out infinite;
    }
    @keyframes triviaPop{
      0%,100%{ transform: scale(1) translateY(0); filter: brightness(1); }
      50%{ transform: scale(1.035) translateY(-2px); filter: brightness(1.12); }
    }
    .logoText::after{
      content:"";
      position:absolute;
      inset:-18px -40px;
      background:
        radial-gradient(circle at 20% 30%, rgba(212,175,55,0.18), transparent 55%),
        radial-gradient(circle at 80% 70%, rgba(212,175,55,0.10), transparent 60%);
      filter: blur(8px);
      z-index:-1;
      opacity:0.95;
      animation: glowDrift 2.8s ease-in-out infinite;
      pointer-events:none;
    }
    @keyframes glowDrift{
      0%,100%{ transform: translate(0,0); opacity:0.75; }
      50%{ transform: translate(10px, -6px); opacity:1; }
    }

    .tagline{
      margin:0;
      font-size:30px;
      line-height:1.35;
      color:#e5e7eb;
      opacity:0.98;
      max-width:1200px;
      text-shadow: 0 14px 40px rgba(0,0,0,0.55);
    }

    .subline{
      margin:0;
      font-size:18px;
      line-height:1.45;
      color: var(--muted);
      max-width:1150px;
    }

    /* “Sala lista...” line w typing dots */
    .waitLine{
      margin-top:18px;
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:12px 18px;
      border-radius:999px;
      border:1px solid rgba(212,175,55,0.28);
      background: rgba(10,25,47,0.55);
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      font-size:16px;
      color:#e5e7eb;
      letter-spacing:0.04em;
      max-width:92%;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .typingDots{
      display:inline-flex;
      align-items:center;
      gap:6px;
      transform: translateY(1px);
    }
    .typingDots span{
      width:7px; height:7px; border-radius:999px;
      background: var(--gold);
      opacity:0.18;
      animation: typing 1.1s infinite ease-in-out;
    }
    .typingDots span:nth-child(2){ animation-delay: 0.18s; }
    .typingDots span:nth-child(3){ animation-delay: 0.36s; }
    @keyframes typing{
      0%{ opacity:0.18; transform: translateY(0) scale(0.95); }
      35%{ opacity:1; transform: translateY(-3px) scale(1.05); }
      70%{ opacity:0.24; transform: translateY(0) scale(1); }
      100%{ opacity:0.18; transform: translateY(0) scale(0.95); }
    }

    /* ===== LIVE ===== */
    .liveWrap{
      position:absolute;
      inset:0;
      display:none; /* toggled by JS */
      padding:46px 58px 54px;
      z-index:2;
    }

    /* HUD (timer centered) */
    .hud{
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;
      gap:18px;
      padding:14px 20px;
      border-radius:999px;
      background: rgba(2,11,27,0.86);
      border: 1px solid var(--border);
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    }

    .hudGroup{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }

    .hudGroup.left{ justify-content:flex-start; }
    .hudGroup.right{ justify-content:flex-end; }

    .hudLabel{
      font-size:14px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color: var(--muted);
      white-space:nowrap;
    }

    /* BIG values */
    .hudValue{
      font-size:44px;
      font-weight:1000;
      letter-spacing:0.06em;
      color: var(--text);
      white-space:nowrap;
      text-shadow: 0 10px 28px rgba(0,0,0,0.55);
    }
    .hudValue.small{
      font-size:34px;
      font-weight:1000;
    }

    /* Timer centerpiece */
    .timerCenter{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:14px;
      padding:6px 18px;
      border-radius:999px;
      border:1px solid rgba(212,175,55,0.45);
      background: rgba(10,25,47,0.72);
      box-shadow: 0 12px 32px rgba(0,0,0,0.35);
    }

    .timerBig{
      font-size:64px;
      font-weight:1000;
      letter-spacing:0.08em;
      line-height:1;
      color: var(--text);
      text-shadow: 0 18px 55px rgba(0,0,0,0.65);
      min-width:110px;
      text-align:center;
    }
    .timerBig.warn{ color: #fde68a; }
    .timerBig.danger{
      color:#fecaca;
      animation: flash 650ms infinite;
      text-shadow:
        0 0 26px rgba(249,115,115,0.45),
        0 18px 55px rgba(0,0,0,0.65);
    }
    @keyframes flash{
      0%,100%{ transform: scale(1); filter: brightness(1); }
      50%{ transform: scale(1.02); filter: brightness(1.25); }
    }

    .pill{
      font-size:12px;
      padding:7px 14px;
      border-radius:999px;
      border:1px solid rgba(212,175,55,0.55);
      background: rgba(10,25,47,0.9);
      color: var(--text);
      letter-spacing:0.14em;
      text-transform:uppercase;
      white-space:nowrap;
      flex:0 0 auto;
    }
    .pill.bad{ border-color: var(--danger); color:#fecaca; }
    .pill.good{ border-color: rgba(16,185,129,0.9); color:#a7f3d0; }

    /* timer bar */
    .timerbar{
      margin-top:12px;
      height:12px;
      border-radius:999px;
      background: rgba(148,163,184,0.18);
      overflow:hidden;
      border:1px solid rgba(55,65,81,0.55);
    }
    .timerfill{
      height:100%;
      width:100%;
      background: linear-gradient(to right, var(--gold), #f9fafb);
      transform-origin:left center;
      transform: scaleX(1);
      transition: transform 0.1s linear;
    }
    .timerbar.danger{
      box-shadow: 0 0 0 2px rgba(249,115,115,0.14), 0 10px 26px rgba(0,0,0,0.35);
      border-color: rgba(249,115,115,0.6);
    }

    /* QA area */
    .qa{
      margin-top:28px;
      height: calc(100% - 120px);
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      gap:26px;
      position:relative;
    }

    /* question block with bulbs */
    .qBlock{
      margin:0 auto;
      width:min(1540px, 100%);
      background: linear-gradient(180deg, rgba(2,6,23,0.70), rgba(2,6,23,0.48));
      border:1px solid rgba(55,65,81,0.8);
      border-radius:22px;
      padding:26px 30px;
      position:relative;
      overflow:hidden;
      box-shadow: 0 18px 55px rgba(0,0,0,0.55);
    }
    .qBlock::before{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius:24px;
      pointer-events:none;
      opacity:0.65;
      background:
        radial-gradient(circle at 8% 18%, rgba(212,175,55,0.90) 0 4px, transparent 5px),
        radial-gradient(circle at 16% 10%, rgba(212,175,55,0.90) 0 4px, transparent 5px),
        radial-gradient(circle at 26% 16%, rgba(212,175,55,0.90) 0 4px, transparent 5px),
        radial-gradient(circle at 74% 16%, rgba(212,175,55,0.90) 0 4px, transparent 5px),
        radial-gradient(circle at 84% 10%, rgba(212,175,55,0.90) 0 4px, transparent 5px),
        radial-gradient(circle at 92% 18%, rgba(212,175,55,0.90) 0 4px, transparent 5px),
        radial-gradient(circle at 10% 86%, rgba(212,175,55,0.90) 0 4px, transparent 5px),
        radial-gradient(circle at 20% 92%, rgba(212,175,55,0.90) 0 4px, transparent 5px),
        radial-gradient(circle at 34% 88%, rgba(212,175,55,0.90) 0 4px, transparent 5px),
        radial-gradient(circle at 66% 88%, rgba(212,175,55,0.90) 0 4px, transparent 5px),
        radial-gradient(circle at 80% 92%, rgba(212,175,55,0.90) 0 4px, transparent 5px),
        radial-gradient(circle at 90% 86%, rgba(212,175,55,0.90) 0 4px, transparent 5px);
      animation: bulbs 1.1s ease-in-out infinite;
      filter: drop-shadow(0 0 8px rgba(212,175,55,0.35));
    }
    @keyframes bulbs{ 0%,100%{ opacity:0.35; } 50%{ opacity:0.8; } }

    .qText{
      margin:0;
      font-size:58px;
      line-height:1.06;
      font-weight:1000;
      letter-spacing:-0.01em;
      text-align:center;
      color: var(--text);
      word-wrap:break-word;
      overflow-wrap:anywhere;
      text-shadow: 0 18px 55px rgba(0,0,0,0.55);
    }

    /* choices */
    .choices{
      margin:0 auto;
      width:min(1580px, 100%);
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:18px;
      align-content:start;
      transition: opacity 220ms ease, transform 220ms ease;
    }
    /* hidden during 5s “host reads” */
    .choices.hidden{
      opacity:0;
      transform: translateY(8px);
      pointer-events:none;
    }

    .choice{
      border-radius:20px;
      border:1px solid rgba(55,65,81,0.9);
      background: linear-gradient(180deg, rgba(2,6,23,0.80), rgba(2,6,23,0.64));
      padding:22px 22px;
      min-height:140px;
      display:flex;
      gap:14px;
      align-items:flex-start;
      box-shadow: 0 10px 26px rgba(0,0,0,0.35);
      position:relative;
      overflow:hidden;
    }
    .choice::after{
      content:"";
      position:absolute;
      inset:0;
      background: radial-gradient(circle at 20% 10%, rgba(212,175,55,0.14), transparent 40%);
      opacity:0.7;
      pointer-events:none;
    }

    .choiceKey{
      width:60px;
      height:60px;
      border-radius:18px;
      display:flex;
      align-items:center;
      justify-content:center;
      border:1px solid rgba(212,175,55,0.55);
      background: rgba(10,25,47,0.85);
      color: var(--gold);
      font-weight:1000;
      font-size:22px;
      flex:0 0 auto;
      box-shadow: inset 0 0 0 1px rgba(212,175,55,0.15);
    }
    .choiceText{
      font-size:28px;
      line-height:1.18;
      color: var(--text);
      word-wrap:break-word;
      overflow-wrap:anywhere;
      padding-top:6px;
    }

    /* highlight states */
    .choice.correct{
      border-color: rgba(16,185,129,0.95);
      box-shadow: 0 0 0 3px rgba(16,185,129,0.18), 0 18px 55px rgba(0,0,0,0.55);
    }
    .choice.correct .choiceKey{
      border-color: rgba(16,185,129,0.95);
      color:#a7f3d0;
    }
    .choice.wrong{
      border-color: rgba(249,115,115,0.95);
      box-shadow: 0 0 0 3px rgba(249,115,115,0.15), 0 18px 55px rgba(0,0,0,0.55);
    }
    .choice.wrong .choiceKey{
      border-color: rgba(249,115,115,0.95);
      color:#fecaca;
    }

    /* ===== OVERLAY FEEDBACK ===== */
    .overlay{
      position:absolute;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      gap:10px;
      z-index:5;
      background: radial-gradient(circle at center, rgba(2,11,27,0.35), rgba(2,11,27,0.75));
      backdrop-filter: blur(2px);
    }
    .overlay.show{ display:flex; }

    .pickBadge{
      font-size:64px;
      font-weight:1000;
      letter-spacing:0.10em;
      padding:18px 28px;
      border-radius:999px;
      border:2px solid rgba(212,175,55,0.55);
      background: rgba(10,25,47,0.88);
      color: var(--gold);
      box-shadow: 0 18px 55px rgba(0,0,0,0.55);
      text-transform:uppercase;
    }

    .bigResult{
      font-size:132px;
      font-weight:1000;
      letter-spacing:0.06em;
      line-height:1;
      margin:0;
      text-transform:uppercase;
      text-shadow: 0 18px 55px rgba(0,0,0,0.65);
    }
    .bigResult.correct{
      color:#a7f3d0;
      text-shadow:
        0 0 24px rgba(16,185,129,0.35),
        0 18px 55px rgba(0,0,0,0.65);
      animation: pop 650ms ease-out;
    }
    .bigResult.wrong{
      color:#fecaca;
      text-shadow:
        0 0 24px rgba(249,115,115,0.35),
        0 18px 55px rgba(0,0,0,0.65);
      animation: pop 650ms ease-out;
    }
    @keyframes pop{
      0%{ transform: scale(0.90); opacity:0; filter: blur(1px); }
      35%{ transform: scale(1.03); opacity:1; filter: blur(0); }
      100%{ transform: scale(1); opacity:1; }
    }

    /* ===== FINAL ===== */
    .final{
      position:absolute;
      inset:0;
      display:none; /* toggled by JS */
      align-items:center;
      justify-content:center;  /* center CENTER */
      flex-direction:column;
      text-align:center;
      padding:0 90px;          /* remove heavy top/bottom padding */
      gap:18px;
      z-index:4;
    }
    .finalLabel{
      font-size:16px;
      letter-spacing:0.22em;
      text-transform:uppercase;
      color: var(--gold);
      margin:0;
    }
    .bigScore{
      font-size:160px;
      font-weight:1000;
      letter-spacing:0.06em;
      color: var(--text);
      margin:0;
      line-height:1.0;
      text-shadow: 0 18px 55px rgba(0,0,0,0.65);
    }
    .finalThanks{
      margin:0;
      font-size:46px;
      font-weight:900;
      letter-spacing:0.04em;
      color:#e5e7eb;
      opacity:0.95;
      text-shadow: 0 18px 55px rgba(0,0,0,0.55);
    }
    .finalSub{
      margin:0;
      font-size:20px;
      color: var(--muted);
    }

    /* ===== FOOTER (Legal) ===== */
    .legalFooter{
      position:absolute;
      left:0;
      right:0;
      bottom:14px;
      display:flex;
      justify-content:center;
      pointer-events:none;
      z-index:6; /* above everything including overlay/final */
    }
    .legalFooter .inner{
      max-width:92%;
      text-align:center;
      font-size:14px; /* not super small */
      color: rgba(156,163,175,0.95);
      letter-spacing:0.04em;
      line-height:1.35;
      padding:8px 16px;
      border-radius:999px;
      border:1px solid rgba(212,175,55,0.22);
      background: rgba(2,11,27,0.42);
      backdrop-filter: blur(2px);
      box-shadow: 0 10px 26px rgba(0,0,0,0.28);
    }

    /* responsive safety */
    @media (max-width: 1100px){
      .splashLogo{ width:min(420px, 70%); }
      .logoText{ font-size:70px; }
      .qText{ font-size:42px; }
      .choiceText{ font-size:20px; }
      .liveWrap{ padding:22px; }
      .choice{ min-height:120px; }
      .hudValue{ font-size:36px; }
      .timerBig{ font-size:46px; min-width:84px; }
      .bigResult{ font-size:88px; }
      .bigScore{ font-size:120px; }
      .finalThanks{ font-size:34px; }
      .pickBadge{ font-size:44px; }
      .legalFooter .inner{ font-size:12px; }
      .tagline{ font-size:22px; }
    }
    
    @media (max-width: 900px){
      body{ padding:10px; }
      .stage{ border-radius:16px; }
      .choices{ grid-template-columns:1fr; }
      .qText{ font-size:32px; }
      .logoText{ font-size:54px; }
      .tagline{ font-size:18px; }
      .hud{ grid-template-columns: 1fr; gap:10px; border-radius:22px; }
      .hudGroup.left, .hudGroup.right{ justify-content:center; }
      .timerCenter{ justify-content:center; }
      .hudValue{ font-size:30px; }
      .hudValue.small{ font-size:26px; }
    }
  </style>
</head>
<body>
  <div class="stage" id="stage">
      <!-- NYE Animated Background (behind UI) -->
  <div class="nyeBg" aria-hidden="true">
    <div class="nyeLayer sparkles"></div>
    <div class="nyeLayer bokeh"></div>
    <div class="nyeLayer fireworks"></div>
    <div class="nyeLayer confetti"></div>
    <div class="nyeVignette"></div>
  </div>
    <!-- SPLASH -->
    <div class="splash" id="splash">
      <img class="splashLogo" src="Assets/Logo_MM_Text.png" alt="Municipio de Mayagüez" draggable="false" />
      <h1 class="logoText">TRIVIA</h1>
      <p class="tagline" id="tagline">¿Puedes contestar las 5 preguntas?</p>
      <p class="subline">Un invitado a la vez. El host inicia desde el control en el teléfono.</p>

      <div class="waitLine" aria-live="polite">
        Sala lista, esperando por próximo jugador
        <span class="typingDots" aria-hidden="true">
          <span></span><span></span><span></span>
        </span>
      </div>
    </div>

    <!-- LIVE -->
    <section class="liveWrap" id="live">
      <div class="hud">
        <div class="hudGroup left">
          <div class="hudLabel">Puntos</div>
          <div class="hudValue" id="mS">0</div>
        </div>

        <div class="timerCenter" aria-label="Tiempo">
          <div class="hudLabel" style="margin-right:6px;">Tiempo</div>
          <div class="timerBig" id="mT">—</div>
          <div id="livePill" class="pill good">EN VIVO</div>
        </div>

        <div class="hudGroup right">
          <div class="hudLabel">Pregunta</div>
          <div class="hudValue small" id="mQ">—</div>
        </div>
      </div>

      <div class="timerbar" id="timerBar">
        <div id="timerFill" class="timerfill"></div>
      </div>

      <div class="qa">
        <div class="qBlock">
          <h2 class="qText" id="qText">—</h2>
        </div>

        <div class="choices hidden" id="choices">
          <div class="choice" id="cA">
            <div class="choiceKey">A</div>
            <div class="choiceText" id="tA">—</div>
          </div>
          <div class="choice" id="cB">
            <div class="choiceKey">B</div>
            <div class="choiceText" id="tB">—</div>
          </div>
          <div class="choice" id="cC">
            <div class="choiceKey">C</div>
            <div class="choiceText" id="tC">—</div>
          </div>
          <div class="choice" id="cD">
            <div class="choiceKey">D</div>
            <div class="choiceText" id="tD">—</div>
          </div>
        </div>
      </div>
    </section>

    <!-- FEEDBACK OVERLAY -->
    <div class="overlay" id="overlay">
      <div class="pickBadge" id="pickBadge">SELECCIÓN: —</div>
      <h2 class="bigResult" id="bigResult">—</h2>
    </div>

    <!-- FINAL -->
    <div class="final" id="final">
      <div class="finalLabel">Puntuación Final</div>
      <h2 class="bigScore" id="finalScore">0 / 5</h2>
      <p class="finalThanks">¡Gracias por participar!</p>
      <p class="finalSub">Reiniciando para el próximo invitado…</p>
    </div>

    <!-- LEGAL FOOTER (always visible) -->
    <div class="legalFooter" aria-hidden="true">
      <div class="inner">
        LuminarApps © 2025 · Municipio de Mayagüez
      </div>
    </div>
  </div>

<script>
const ROOM_CODE = "ACTIVE";
const QUESTION_SECONDS = 30;
const FINAL_HOLD_MS = 30000;

// NEW: host reads question for 5s, THEN answers reveal and timer starts
const READ_MS = 5000;

// Overlay timing
const FEEDBACK_PICK_MS = 450;
const FEEDBACK_RESULT_MS = 5000;     // controls "Correcta/Incorrecta" duration
const ADVANCE_AFTER_FEEDBACK_MS = 250;

// New game length
const GAME_QUESTION_COUNT = 5;

// ====== Question bank (keep all 20) ======
const QUESTIONS = [
  { q:"¿En qué año fue fundado el municipio de Mayagüez?", a:{A:"1703",B:"1760",C:"1805",D:"1823"}, correct:"B" },
  { q:"¿Quién fue el fundador de Mayagüez?", a:{A:"Juan Ponce de León",B:"Faustino Martínez",C:"Cristóbal Colón",D:"Diego Salcedo"}, correct:"B" },
  { q:"¿Qué evento natural destruyó gran parte de la ciudad en 1918?", a:{A:"Un huracán",B:"Un maremoto",C:"Un terremoto",D:"Una erupción volcánica"}, correct:"C" },
  { q:"¿Cómo se llamaba originalmente Mayagüez?", a:{A:"Nuestra Señora de la Candelaria",B:"El Pueblo del Oeste",C:"Mayagüez del Mar",D:"Las Claras"}, correct:"A" },
  { q:"¿Por qué Mayagüez fue conocida como la “Sultana del Oeste”?", a:{A:"Por su arquitectura árabe",B:"Por su importancia económica y cultural",C:"Por su clima cálido",D:"Por su puerto militar"}, correct:"B" },
  { q:"¿Qué catedral se encuentra en la Plaza Colón de Mayagüez?", a:{A:"Catedral San Juan Bautista",B:"Catedral Nuestra Señora de la Candelaria",C:"Catedral del Carmen",D:"Catedral San Germán"}, correct:"B" },
  { q:"¿Cuál es una de las fiestas patronales más importantes de Mayagüez?", a:{A:"San Sebastián",B:"Virgen del Carmen",C:"Nuestra Señora de la Candelaria",D:"Reyes Magos"}, correct:"C" },
  { q:"¿Qué teatro histórico es uno de los íconos culturales de la ciudad?", a:{A:"Teatro Tapia",B:"Teatro Yagüez",C:"Teatro Alejandro Tapia",D:"Teatro de Bellas Artes"}, correct:"B" },
  { q:"¿Qué universidad pública tiene su sede principal en Mayagüez?", a:{A:"Universidad Interamericana",B:"Universidad del Sagrado Corazón",C:"Universidad de Puerto Rico, Recinto de Mayagüez",D:"Universidad Metropolitana"}, correct:"C" },
  { q:"¿Qué apodo reciben los residentes de Mayagüez?", a:{A:"Capitalinos",B:"Mayagüezanos",C:"Isleños",D:"Mayos"}, correct:"B" },
  { q:"¿Cómo se llama el equipo de baloncesto de Mayagüez en el BSN?", a:{A:"Piratas",B:"Mets",C:"Leones",D:"Indios"}, correct:"D" },
  { q:"¿En qué año los Indios de Mayagüez ganaron su campeonato más reciente?", a:{A:"2008",B:"2010",C:"2012",D:"2015"}, correct:"C" },
  { q:"¿Qué evento deportivo internacional se celebró en Mayagüez en 2010?", a:{A:"Juegos Olímpicos",B:"Juegos Panamericanos",C:"Juegos Centroamericanos y del Caribe",D:"Juegos del Caribe"}, correct:"C" },
  { q:"¿Cómo se llama el estadio de béisbol de la ciudad?", a:{A:"Estadio Roberto Clemente",B:"Estadio Isidoro García",C:"Estadio Francisco Pagán",D:"Estadio Juan Ramón Loubriel"}, correct:"B" },
  { q:"¿Qué deporte universitario destaca históricamente en el RUM?", a:{A:"Natación",B:"Atletismo",C:"Baloncesto",D:"Fútbol"}, correct:"C" },
  { q:"¿Qué educador y filósofo puertorriqueño nació en Mayagüez en 1839?", a:{A:"Eugenio María de Hostos",B:"Luis Muñoz Rivera",C:"José Celso Barbosa",D:"Ramón Emeterio Betances"}, correct:"A" },
  { q:"¿Qué cantante y compositor salsero nació en Mayagüez?", a:{A:"Héctor Lavoe",B:"Frankie Ruiz",C:"Willie Colón",D:"Gilberto Santa Rosa"}, correct:"B" },
  { q:"¿Qué poeta del siglo XIX estuvo vinculado a Mayagüez?", a:{A:"Julia de Burgos",B:"Lola Rodríguez de Tió",C:"José Gautier Benítez",D:"Luis Palés Matos"}, correct:"C" },
  { q:"¿Por qué es reconocido el Recinto Universitario de Mayagüez?", a:{A:"Artes y música",B:"Ciencias e ingeniería",C:"Derecho",D:"Medicina"}, correct:"B" },
  { q:"¿Qué rol ha tenido Mayagüez en el desarrollo deportivo de Puerto Rico?", a:{A:"Sede de eventos internacionales",B:"Capital del béisbol profesional",C:"Única ciudad con estadio olímpico",D:"Centro exclusivo del boxeo"}, correct:"A" }
];

const BANK_TOTAL = QUESTIONS.length;

// ====== DOM ======
const splash = document.getElementById("splash");
const live = document.getElementById("live");
const final = document.getElementById("final");
const tagline = document.getElementById("tagline");

const mQ = document.getElementById("mQ");
const mS = document.getElementById("mS");
const mT = document.getElementById("mT");
const timerFill = document.getElementById("timerFill");
const timerBar = document.getElementById("timerBar");

const qText = document.getElementById("qText");
const tA = document.getElementById("tA");
const tB = document.getElementById("tB");
const tC = document.getElementById("tC");
const tD = document.getElementById("tD");
const cA = document.getElementById("cA");
const cB = document.getElementById("cB");
const cC = document.getElementById("cC");
const cD = document.getElementById("cD");
const choicesEl = document.getElementById("choices");

const overlay = document.getElementById("overlay");
const pickBadge = document.getElementById("pickBadge");
const bigResult = document.getElementById("bigResult");

const finalScore = document.getElementById("finalScore");

// ====== Helpers (random unique 5) ======
function makeRandomIndexSet(bankLen, pickN){
  const n = Math.max(1, Math.min(pickN, bankLen));
  const arr = Array.from({length: bankLen}, (_, i) => i);
  for (let i = arr.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr.slice(0, n);
}

// ====== Runtime round selection ======
let roundOrder = makeRandomIndexSet(BANK_TOTAL, GAME_QUESTION_COUNT);
function getCurrentQuestion(){
  const bankIndex = roundOrder[state.qIndex];
  return QUESTIONS[bankIndex];
}

// ====== State ======
let hostToken = localStorage.getItem("trivia_hostToken") || "";
let state = {
  phase: "splash",       // splash | live | feedback | finished
  total: GAME_QUESTION_COUNT,
  qIndex: 0,
  score: 0,
  questionEndsAt: null,
  questionText: "",
  answers: null
};

// local-only read phase (NOT pushed to controller)
let localReading = false;
let revealTimer = null;

let tickTimer = null;
let lastSeq = 0;

let resolving = false;
let advancedForQ = -1;
let timeoutHandledForQ = -1;

function setView(which){
  splash.style.display = which === "splash" ? "flex" : "none";
  live.style.display   = which === "live"   ? "block" : "none";
  final.style.display  = which === "final"  ? "flex" : "none";
}

function clearHighlights(){
  [cA,cB,cC,cD].forEach(el=> el.classList.remove("correct","wrong"));
}

function syncStateForController(){
  const q = getCurrentQuestion();
  state.questionText = q.q;
  state.answers = { ...q.a };
  state.total = GAME_QUESTION_COUNT;
}

function setTimerDanger(on){
  if (on) timerBar.classList.add("danger");
  else timerBar.classList.remove("danger");
}

function resetTimerUI(){
  mT.textContent = "—";
  mT.classList.remove("warn","danger");
  timerFill.style.transform = "scaleX(0)";
  setTimerDanger(false);
}

/* ====== 5s READ then REVEAL answers + START timer ====== */
function beginReadThenReveal(){
  // UI: show question only, hide answers
  localReading = true;
  choicesEl.classList.add("hidden");
  resetTimerUI();

  // controller stays in splash for 5s (buttons disabled) — we do NOT push "live" yet.
  // after 5 seconds: reveal answers + start exact 30s timer
  if (revealTimer) clearTimeout(revealTimer);
  revealTimer = setTimeout(()=>{
    localReading = false;

    // reveal answers
    choicesEl.classList.remove("hidden");

    // now start the real answering phase + push to controller
    state.phase = "live";
    state.questionEndsAt = Date.now() + QUESTION_SECONDS * 1000;
    syncStateForController();
    hostPush();
  }, READ_MS);
}

function renderQuestion(){
  const q = getCurrentQuestion();

  qText.textContent = q.q;

  // preload texts (won't be visible until reveal)
  tA.textContent = q.a.A;
  tB.textContent = q.a.B;
  tC.textContent = q.a.C;
  tD.textContent = q.a.D;

  mQ.textContent = `${state.qIndex+1}/${GAME_QUESTION_COUNT}`;
  mS.textContent = `${state.score}`;

  clearHighlights();

  overlay.classList.remove("show");
  bigResult.classList.remove("correct","wrong");
  bigResult.textContent = "—";
  pickBadge.textContent = "SELECCIÓN: —";

  resolving = false;
  timeoutHandledForQ = -1;
  advancedForQ = -1;

  // start 5-second read window
  beginReadThenReveal();
}

async function hostPush(){
  if (!hostToken) return;
  try{
    await fetch("/api/host-state",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ roomCode: ROOM_CODE, hostToken, state })
    });
  }catch(_){}
}

async function ensureRoom(){
  try{
    const res = await fetch("/api/create-room",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ roomCode: ROOM_CODE })
    });
    const data = await res.json().catch(()=> ({}));
    if (!res.ok || !data.ok) throw new Error(data.error || "create_room_failed");

    if (data.hostToken) {
      hostToken = data.hostToken;
      localStorage.setItem("trivia_hostToken", hostToken);
    }

    if (!hostToken){
      console.error("NO hostToken available. Big screen cannot poll answers.");
      setView("splash");
      return;
    }

    await hostPush();
  }catch(err){
    console.error("ensureRoom error:", err);
    setView("splash");
  }
}

function startNewRound(){
  // new random order every round
  roundOrder = makeRandomIndexSet(BANK_TOTAL, GAME_QUESTION_COUNT);

  // controller stays disabled during read window, so backend phase is "splash" for a moment
  state.phase = "splash";
  state.qIndex = 0;
  state.score = 0;
  state.total = GAME_QUESTION_COUNT;
  state.questionEndsAt = null;
  state.questionText = "";
  state.answers = null;

  setView("live");
  renderQuestion();
  hostPush(); // splash state (keeps phone disabled)
}

function showFinal(){
  state.phase = "finished";
  state.questionEndsAt = null;
  hostPush();

  overlay.classList.remove("show");
  bigResult.classList.remove("correct","wrong");
  bigResult.textContent = "—";
  pickBadge.textContent = "SELECCIÓN: —";
  clearHighlights();

  setView("final");
  finalScore.textContent = `${state.score} / ${GAME_QUESTION_COUNT}`;

  setTimeout(()=> resetToSplash(), FINAL_HOLD_MS);
}

async function resetToSplash(){
  if (!hostToken){
    await ensureRoom();
    if (!hostToken){
      setView("splash");
      return;
    }
  }

  if (revealTimer) clearTimeout(revealTimer);
  revealTimer = null;
  localReading = false;

  state = { phase:"reset", total:GAME_QUESTION_COUNT, qIndex:0, score:0, questionEndsAt:null, reset:true };
  await hostPush();

  state = { phase:"splash", total:GAME_QUESTION_COUNT, qIndex:0, score:0, questionEndsAt:null, questionText:"", answers:null };
  await hostPush();

  setView("splash");

  mQ.textContent = "—";
  mS.textContent = "0";
  resetTimerUI();
  clearHighlights();
  overlay.classList.remove("show");

  resolving = false;
  lastSeq = 0;
  advancedForQ = -1;
  timeoutHandledForQ = -1;

  tagline.textContent = `¿Puedes contestar las ${GAME_QUESTION_COUNT} preguntas?`;
}

function pickToChoiceEl(choice){
  return {A:cA,B:cB,C:cC,D:cD}[choice] || null;
}

function scheduleAdvance(){
  if (advancedForQ === state.qIndex) return;
  advancedForQ = state.qIndex;
  setTimeout(()=> advance(), ADVANCE_AFTER_FEEDBACK_MS);
}

function enterFeedbackPhase(){
  state.phase = "feedback";
  state.questionEndsAt = null;
  hostPush();
}

function showOverlayPick(choice){
  overlay.classList.add("show");
  pickBadge.textContent = `SELECCIÓN: ${choice}`;
  bigResult.classList.remove("correct","wrong");
  bigResult.textContent = "";
}

function showOverlayResult(isCorrect, text){
  bigResult.classList.remove("correct","wrong");
  bigResult.classList.add(isCorrect ? "correct" : "wrong");
  bigResult.textContent = text || (isCorrect ? "CORRECTA" : "INCORRECTA");
}

function applyAnswer(choice){
  // only accept answers once the reveal is done and backend is live
  if (localReading) return;
  if (state.phase !== "live") return;
  if (resolving) return;

  resolving = true;
  enterFeedbackPhase();

  const q = getCurrentQuestion();
  const isCorrect = (choice === q.correct);

  const chosenEl = pickToChoiceEl(choice);
  if (chosenEl) chosenEl.classList.add(isCorrect ? "correct" : "wrong");

  if (isCorrect) state.score += 1;
  mS.textContent = `${state.score}`;

  showOverlayPick(choice);

  setTimeout(()=>{
    showOverlayResult(isCorrect, isCorrect ? "CORRECTA" : "INCORRECTA");
    hostPush();
    setTimeout(()=> scheduleAdvance(), FEEDBACK_RESULT_MS);
  }, FEEDBACK_PICK_MS);
}

function applyTimeout(){
  if (localReading) return;
  if (state.phase !== "live") return;
  if (timeoutHandledForQ === state.qIndex) return;
  timeoutHandledForQ = state.qIndex;

  if (!resolving){
    resolving = true;
    enterFeedbackPhase();

    showOverlayPick("—");
    setTimeout(()=>{
      showOverlayResult(false, "TIEMPO");
      hostPush();
      setTimeout(()=> scheduleAdvance(), 1400);
    }, FEEDBACK_PICK_MS);
  } else {
    scheduleAdvance();
  }
}

function advance(){
  if (state.phase !== "live" && state.phase !== "feedback" && state.phase !== "splash") return;

  if (state.qIndex >= GAME_QUESTION_COUNT - 1){
    showFinal();
    return;
  }

  if (revealTimer) clearTimeout(revealTimer);
  revealTimer = null;
  localReading = false;

  state.qIndex += 1;

  // keep controller disabled during read window
  state.phase = "splash";
  state.questionEndsAt = null;
  state.questionText = "";
  state.answers = null;
  hostPush();

  renderQuestion();
}

async function pollAnswersLoop(){
  if (!hostToken){
    await ensureRoom();
    if (!hostToken) return;
  }

  try{
    const url = `/api/poll-answer?roomCode=${encodeURIComponent(ROOM_CODE)}&hostToken=${encodeURIComponent(hostToken)}&afterSeq=${encodeURIComponent(lastSeq)}`;
    const res = await fetch(url);
    const data = await res.json().catch(()=> ({}));
    if (!res.ok || !data.ok) return;

    if (typeof data.seq === "number") {
      if (data.seq <= lastSeq) return;
      lastSeq = data.seq;
    }

    if (!data.answer) return;

    const choice = String(data.answer.choice || "").trim().toUpperCase();
    const validChoice = ["A","B","C","D"].includes(choice);

    if (choice === "__START__"){
      if (state.phase === "finished"){
        resetToSplash();
        setTimeout(()=> startNewRound(), 250);
        return;
      }
      if (splash.style.display !== "none"){
        startNewRound();
      } else if (state.phase !== "live" && state.phase !== "feedback" && !localReading){
        startNewRound();
      }
      return;
    }

    // If splash screen visible, start round (first real answer also starts round)
    if (splash.style.display !== "none"){
      startNewRound();
      // NOTE: first 5 seconds are read-only, so we ignore this answer (by design)
      return;
    }

    if (state.phase === "live" && validChoice){
      applyAnswer(choice);
    }

  }catch(_){}
}

function tick(){
  // During 5s read window, timer should not run
  if (localReading || state.phase !== "live" || !state.questionEndsAt){
    // Only reset if we previously showed a running timer
    if (mT.textContent !== "—") resetTimerUI();
    return;
  }

  const msLeft = state.questionEndsAt - Date.now();
  const sLeft = Math.max(0, Math.ceil(msLeft/1000));

  mT.textContent = `${sLeft}`;
  mT.classList.remove("warn","danger");
  if (sLeft <= 5) mT.classList.add("danger");
  else if (sLeft <= 15) mT.classList.add("warn");

  const pct = Math.max(0, Math.min(1, msLeft/(QUESTION_SECONDS*1000)));
  timerFill.style.transform = `scaleX(${pct})`;

  setTimerDanger(sLeft <= 10);

  if (msLeft <= 0){
    applyTimeout();
  }
}

let pollerRunning = false;
let pollerTimeout = null;

function getPollMs(){
  // keep responsive
  if (state.phase === "live" || state.phase === "feedback" || localReading) return 500;
  return 1200;
}

async function pollerTick(){
  if (!pollerRunning) return;
  await pollAnswersLoop();
  pollerTimeout = setTimeout(pollerTick, getPollMs());
}

function startPoller(){
  if (pollerRunning) return;
  pollerRunning = true;
  if (pollerTimeout) clearTimeout(pollerTimeout);
  pollerTimeout = setTimeout(pollerTick, getPollMs());
}

async function bootstrap(){
  setView("splash");
  tagline.textContent = `¿Puedes contestar las ${GAME_QUESTION_COUNT} preguntas?`;

  await ensureRoom();

  // HARD RESET ON LOAD
  await resetToSplash();

  startPoller();
  if (!tickTimer) tickTimer = setInterval(tick, 100);

  // Spacebar fallback
  window.addEventListener("keydown",(e)=>{
    if (e.code === "Space"){
      e.preventDefault();
      if (splash.style.display !== "none") startNewRound();
    }
  });
}

bootstrap();
</script>
</body>
</html>
