<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TriviaApp - User Controller</title>
  <style>
    :root{
      --bg:#0b0f1a;
      --panel:#111a2e;
      --text:#e9eefc;
      --muted:#9fb0df;
      --stroke:#233055;
      --accent:#6aa6ff;
      --good:#23c55e;
      --bad:#ef4444;
      --warn:#f59e0b;

      --a:#2b4bff;
      --b:#00d5cf;
      --c:#ff4bd8;
      --d:#ffd34b;

      --radius: 18px;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background: radial-gradient(900px 700px at 50% 15%, #14204a 0%, var(--bg) 60%); color: var(--text); }
    button, input{ font: inherit; }

    .wrap{
      min-height:100%;
      display:grid;
      place-items:center;
      padding: 18px;
    }

    .card{
      width: min(520px, 96vw);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border: 1px solid var(--stroke);
      border-radius: 22px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .top{
      padding: 16px 18px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      background: linear-gradient(90deg, rgba(106,166,255,.16), rgba(0,0,0,0));
      border-bottom: 1px solid var(--stroke);
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
    }
    .dot{
      width: 12px; height: 12px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 0 6px rgba(106,166,255,.14);
      flex: 0 0 auto;
    }
    .title{
      font-weight: 900;
      letter-spacing: .3px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .pill{
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      color: var(--muted);
      font-weight: 800;
      letter-spacing: .2px;
      white-space: nowrap;
    }
    .pill.good{ color: var(--text); border-color: rgba(35,197,94,.45); background: rgba(35,197,94,.10); }
    .pill.bad{ color: var(--text); border-color: rgba(239,68,68,.45); background: rgba(239,68,68,.10); }
    .pill.warn{ color: var(--text); border-color: rgba(245,158,11,.45); background: rgba(245,158,11,.10); }

    .content{ padding: 18px; }

    .join{
      display:grid;
      gap: 12px;
      padding: 14px;
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      background: rgba(0,0,0,.16);
    }

    .label{
      color: var(--muted);
      font-weight: 900;
      letter-spacing: .35px;
      font-size: 12px;
      text-transform: uppercase;
    }

    .row{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
    }

    input{
      flex: 1 1 220px;
      height: 48px;
      padding: 0 14px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.24);
      color: var(--text);
      font-weight: 900;
      letter-spacing: 3px;
      text-transform: uppercase;
      outline: none;
    }
    input::placeholder{
      color: rgba(159,176,223,.6);
      letter-spacing: 2px;
      font-weight: 800;
      text-transform:none;
    }

    .btn{
      appearance:none;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      color: var(--text);
      height: 48px;
      padding: 0 16px;
      border-radius: 14px;
      font-weight: 900;
      letter-spacing: .2px;
      cursor: pointer;
      transition: transform .08s ease, filter .08s ease;
      flex: 0 0 auto;
    }
    .btn:hover{ filter: brightness(1.08); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{ background: rgba(106,166,255,.18); border-color: rgba(106,166,255,.35); }
    .btn:disabled{ opacity: .5; cursor:not-allowed; }

    .meta{
      margin-top: 12px;
      display:flex;
      justify-content:space-between;
      gap: 10px;
      flex-wrap: wrap;
      color: var(--muted);
      font-weight: 800;
    }

    .questionBox{
      margin-top: 14px;
      padding: 16px 14px;
      border-radius: var(--radius);
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.16);
      display:grid;
      gap: 8px;
    }

    .qNum{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
    }

    .qText{
      font-size: 20px;
      font-weight: 1000;
      line-height: 1.15;
      margin:0;
    }

    .sub{
      color: var(--muted);
      font-weight: 900;
      letter-spacing: .25px;
      font-size: 13px;
      margin:0;
    }

    .answers{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .ansBtn{
      min-height: 94px;
      border-radius: 18px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      color: var(--text);
      font-weight: 1000;
      letter-spacing: .4px;
      font-size: 22px;
      cursor:pointer;
      position: relative;
      overflow:hidden;
      transition: transform .08s ease, filter .08s ease, border-color .12s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .ansBtn:active{ transform: translateY(1px); }
    .ansBtn:disabled{ opacity:.6; cursor:not-allowed; }

    .ansBtn span{
      position: relative;
      z-index: 2;
    }

    .ansBtn::before{
      content:"";
      position:absolute;
      inset: 0;
      opacity: .25;
    }
    .ansBtn.A::before{ background: radial-gradient(700px 250px at 20% 10%, var(--a), transparent 55%); }
    .ansBtn.B::before{ background: radial-gradient(700px 250px at 20% 10%, var(--b), transparent 55%); }
    .ansBtn.C::before{ background: radial-gradient(700px 250px at 20% 10%, var(--c), transparent 55%); }
    .ansBtn.D::before{ background: radial-gradient(700px 250px at 20% 10%, var(--d), transparent 55%); }

    .ansBtn.selected{
      border-color: rgba(106,166,255,.6);
      filter: brightness(1.06);
    }

    .footer{
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px solid var(--stroke);
      display:flex;
      justify-content:space-between;
      gap: 10px;
      flex-wrap: wrap;
      color: var(--muted);
      font-weight: 900;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.60);
      border: 1px solid var(--stroke);
      padding: 10px 14px;
      border-radius: 14px;
      color: var(--text);
      font-weight: 900;
      opacity: 0;
      pointer-events: none;
      transition: opacity .16s ease, transform .16s ease;
      max-width: min(520px, 92vw);
      text-align:center;
    }
    .toast.show{
      opacity: 1;
      transform: translateX(-50%) translateY(-4px);
    }

    @media (max-width: 420px){
      .answers{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div class="brand">
          <div class="dot"></div>
          <div class="title">TriviaApp · Controller</div>
        </div>
        <div class="pill warn" id="connPill">Connecting…</div>
      </div>

      <div class="content">
        <div class="join">
          <div class="label">Room Code</div>
          <div class="row">
            <input id="roomInput" placeholder="Enter code shown on TV" maxlength="6" autocomplete="off" />
            <button class="btn primary" id="joinBtn">Join</button>
          </div>
          <div class="meta">
            <div>Room: <span id="roomLabel">—</span></div>
            <div>Score: <span id="scoreLabel">0</span></div>
          </div>
        </div>

        <div class="questionBox" id="questionBox" style="display:none;">
          <div class="qNum">
            <p class="sub" id="qCount">Question —</p>
            <p class="sub" id="phaseLabel">Waiting…</p>
          </div>
          <p class="qText" id="qText">—</p>
        </div>

        <div class="answers" id="answers" style="display:none;">
          <button class="ansBtn A" data-letter="A"><span>A</span></button>
          <button class="ansBtn B" data-letter="B"><span>B</span></button>
          <button class="ansBtn C" data-letter="C"><span>C</span></button>
          <button class="ansBtn D" data-letter="D"><span>D</span></button>
        </div>

        <div class="footer">
          <div>Status: <span id="statusLabel">Not joined</span></div>
          <div>Pick: <span id="pickLabel">—</span></div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Socket.IO CDN -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
  <script>
    /******************************************************************
     * USER CONTROLLER (Phone) — paste-ready.
     *
     * Flow:
     * 1) User enters room code shown on TV
     * 2) User taps A/B/C/D
     * 3) We emit "user_answer" { roomCode, choice }
     *
     * We also listen for "host_state" so the phone can display:
     * - current question text (optional)
     * - lock state (disable buttons after answering)
     ******************************************************************/

    const connPill = document.getElementById("connPill");
    const toast = document.getElementById("toast");

    const roomInput = document.getElementById("roomInput");
    const joinBtn = document.getElementById("joinBtn");

    const roomLabel = document.getElementById("roomLabel");
    const scoreLabel = document.getElementById("scoreLabel");
    const statusLabel = document.getElementById("statusLabel");
    const pickLabel = document.getElementById("pickLabel");

    const questionBox = document.getElementById("questionBox");
    const answersWrap = document.getElementById("answers");
    const qCount = document.getElementById("qCount");
    const qText = document.getElementById("qText");
    const phaseLabel = document.getElementById("phaseLabel");

    const ansButtons = [...document.querySelectorAll(".ansBtn")];

    const state = {
      connected: false,
      roomCode: null,
      joined: false,

      // Per question
      locked: false,
      picked: null, // "A"|"B"|"C"|"D"

      // From host snapshot
      phase: "splash",
      score: 0,
      qIndex: 0,
      total: 20, // used for display only
    };

    function setToast(msg, ms=1200){
      toast.textContent = msg;
      toast.classList.add("show");
      window.clearTimeout(setToast._t);
      setToast._t = window.setTimeout(()=>toast.classList.remove("show"), ms);
    }

    function normalizeCode(s){
      return String(s || "")
        .toUpperCase()
        .replace(/[^A-Z0-9]/g, "")
        .slice(0,6);
    }

    function setUI(){
      connPill.textContent = state.connected ? "Connected" : "Connecting…";
      connPill.className = "pill " + (state.connected ? "good" : "warn");

      roomLabel.textContent = state.roomCode || "—";
      scoreLabel.textContent = String(state.score);

      if(!state.joined){
        statusLabel.textContent = "Not joined";
        phaseLabel.textContent = "Waiting…";
        pickLabel.textContent = "—";
        questionBox.style.display = "none";
        answersWrap.style.display = "none";
        setButtonsDisabled(true);
        joinBtn.disabled = !state.connected;
        return;
      }

      joinBtn.disabled = true;

      statusLabel.textContent = state.locked ? "Locked (answered)" : "Ready";
      pickLabel.textContent = state.picked || "—";

      // Show question only once host is in question phase
      if(state.phase === "question"){
        questionBox.style.display = "grid";
        answersWrap.style.display = "grid";
        phaseLabel.textContent = "Answer now";
        setButtonsDisabled(state.locked);
      } else if(state.phase === "countdown"){
        questionBox.style.display = "grid";
        answersWrap.style.display = "none";
        phaseLabel.textContent = "Countdown…";
        setButtonsDisabled(true);
      } else if(state.phase === "finished"){
        questionBox.style.display = "grid";
        answersWrap.style.display = "none";
        phaseLabel.textContent = "Finished";
        setButtonsDisabled(true);
      } else {
        // splash or unknown
        questionBox.style.display = "grid";
        answersWrap.style.display = "none";
        phaseLabel.textContent = "Waiting for host…";
        setButtonsDisabled(true);
      }
    }

    function setButtonsDisabled(disabled){
      ansButtons.forEach(b => b.disabled = !!disabled);
    }

    function clearSelected(){
      ansButtons.forEach(b => b.classList.remove("selected"));
    }

    function selectButton(letter){
      clearSelected();
      const btn = ansButtons.find(b => b.dataset.letter === letter);
      if(btn) btn.classList.add("selected");
    }

    // Socket wiring
    // If your socket server is elsewhere:
    // const socket = io("https://your-socket-domain.com", { transports:["websocket"] });
    const socket = io({ transports: ["websocket", "polling"] });

    socket.on("connect", () => {
      state.connected = true;
      setUI();
    });

    socket.on("disconnect", () => {
      state.connected = false;
      setUI();
    });

    // Server confirms join (optional)
    socket.on("room_joined", (payload) => {
      if(payload && payload.roomCode && payload.roomCode === state.roomCode){
        setToast("Paired ✅");
      }
    });

    // Receive host state snapshots (this is how phone knows question + lock)
    socket.on("host_state", (payload) => {
      if(!payload || !payload.roomCode) return;
      if(!state.roomCode || payload.roomCode !== state.roomCode) return;

      const snap = payload.state || {};
      state.phase = snap.phase || state.phase;

      // score + q index
      if(typeof snap.score === "number") state.score = snap.score;
      if(typeof snap.qIndex === "number") state.qIndex = snap.qIndex;

      // When the host advances, unlock for the next question
      // (Host will set locked=false, lastChoice=null)
      if(typeof snap.locked === "boolean") state.locked = snap.locked;

      if(!state.locked){
        state.picked = null;
        clearSelected();
      }

      // Question display (optional)
      if(snap.question && snap.question.text){
        qText.textContent = snap.question.text;
      } else if(state.phase === "finished"){
        qText.textContent = "Game Over";
      } else {
        qText.textContent = "—";
      }

      // Question count text
      const qNum = state.phase === "question" ? (state.qIndex + 1) : state.qIndex;
      qCount.textContent = `Question ${state.phase === "question" ? (state.qIndex + 1) : "—"}`;

      setUI();
    });

    // Join room
    function joinRoom(){
      const code = normalizeCode(roomInput.value);
      if(code.length !== 6){
        setToast("Enter a valid 6-character code");
        return;
      }

      state.roomCode = code;
      state.joined = true;
      state.locked = false;
      state.picked = null;
      clearSelected();

      roomInput.value = code;
      setUI();

      socket.emit("user_join_room", { roomCode: code });
      setToast("Joining…");
    }

    joinBtn.addEventListener("click", joinRoom);
    roomInput.addEventListener("input", (e) => {
      const v = normalizeCode(e.target.value);
      if(v !== e.target.value) e.target.value = v;
    });
    roomInput.addEventListener("keydown", (e) => {
      if(e.key === "Enter") joinRoom();
    });

    // Send answer
    function sendAnswer(letter){
      if(!state.joined) return;
      if(state.locked) return;
      if(!["A","B","C","D"].includes(letter)) return;

      state.locked = true;
      state.picked = letter;
      selectButton(letter);
      setUI();

      socket.emit("user_answer", { roomCode: state.roomCode, choice: letter });
    }

    ansButtons.forEach(btn => {
      btn.addEventListener("click", () => sendAnswer(btn.dataset.letter));
    });

    // Initial UI
    setUI();
  </script>
</body>
</html>
