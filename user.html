<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TriviaApp - Controller</title>

  <!-- ‚úÖ Disable pinch + double-tap zoom -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <style>
    :root{
      --navy:#0A192F;
      --gold:#D4AF37;
      --danger:#F97373;
      --success:#10B981;
      --muted:#9CA3AF;
      --panel:#020b1b;
      --panel2:#020617;
      --border:rgba(212,175,55,0.35);
      --text:#F4F4F4;

      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      color: var(--text);
      background: var(--navy);
    }
    *{ box-sizing:border-box; }

    /* ‚úÖ Prevent double-tap zoom / gestures and highlight */
    html, body{
      height:100%;
      overscroll-behavior: none;
      -webkit-text-size-adjust: 100%;
      touch-action: manipulation;
    }

    body{
      margin:0;
      min-height:100svh;
      display:flex;
      align-items:stretch;
      justify-content:center;
      padding:14px 12px;
      background:
        radial-gradient(circle at top, rgba(212,175,55,0.10), transparent 45%),
        radial-gradient(circle at 20% 20%, rgba(16,185,129,0.08), transparent 40%),
        radial-gradient(circle at top, #0f172a, var(--navy));
      overflow:hidden; /* ‚úÖ no horizontal scroll ever */
    }

    /* ====== STAGE ====== */
    .stage{
      isolation:isolate;
      width:100%;
      max-width:560px;
      height: calc(100svh - 28px);     /* ‚úÖ real height lock */
      min-height: calc(100svh - 28px);
      background: rgba(2,11,27,0.96);
      border-radius: 22px;
      border: 1px solid rgba(15, 23, 42, 0.9);
      box-shadow: 0 18px 45px rgba(0,0,0,0.7);
      position:relative;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      padding:12px 14px 14px;
    }

    /* NYE bg behind everything */
    .nyeBg{
      position:absolute;
      inset:0;
      z-index:0;
      pointer-events:none;
      overflow:hidden;
    }
    .nyeBg::before{
      content:"";
      position:absolute;
      inset:-10%;
      background:
        radial-gradient(circle at 18% 22%, rgba(212,175,55,0.18), transparent 42%),
        radial-gradient(circle at 80% 28%, rgba(236,72,153,0.10), transparent 40%),
        radial-gradient(circle at 50% 75%, rgba(34,211,238,0.08), transparent 45%),
        radial-gradient(circle at 60% 10%, rgba(16,185,129,0.06), transparent 45%);
      filter: blur(0.5px);
      opacity: 0.9;
    }
    .nyeLayer{
      position:absolute;
      inset:-30%;
      opacity:0.92;
      mix-blend-mode: screen;
      transform: translateZ(0);
      will-change: transform, opacity;
    }
    .nyeLayer.sparkles{
      background:
        radial-gradient(circle at 10% 20%, rgba(255,255,255,0.75) 0 1px, transparent 2px),
        radial-gradient(circle at 25% 65%, rgba(255,255,255,0.55) 0 1px, transparent 2px),
        radial-gradient(circle at 40% 35%, rgba(255,255,255,0.60) 0 1px, transparent 2px),
        radial-gradient(circle at 55% 15%, rgba(255,255,255,0.50) 0 1px, transparent 2px),
        radial-gradient(circle at 72% 52%, rgba(255,255,255,0.65) 0 1px, transparent 2px),
        radial-gradient(circle at 85% 30%, rgba(255,255,255,0.50) 0 1px, transparent 2px),
        radial-gradient(circle at 90% 78%, rgba(255,255,255,0.55) 0 1px, transparent 2px);
      filter: drop-shadow(0 0 8px rgba(255,255,255,0.10));
      animation: nyeTwinkle 3.2s ease-in-out infinite;
      opacity:0.62;
    }
    @keyframes nyeTwinkle{
      0%,100%{ opacity:0.40; transform: translate(0,0) scale(1); }
      50%{ opacity:0.85; transform: translate(1.2%, -0.8%) scale(1.02); }
    }
    .nyeLayer.bokeh{
      background:
        radial-gradient(circle at 12% 30%, rgba(212,175,55,0.22) 0 140px, transparent 160px),
        radial-gradient(circle at 35% 78%, rgba(236,72,153,0.16) 0 180px, transparent 210px),
        radial-gradient(circle at 78% 18%, rgba(34,211,238,0.14) 0 200px, transparent 240px),
        radial-gradient(circle at 86% 72%, rgba(16,185,129,0.10) 0 170px, transparent 210px),
        radial-gradient(circle at 52% 42%, rgba(255,255,255,0.06) 0 240px, transparent 300px);
      filter: blur(6px);
      opacity:0.52;
      animation: nyeFloat 12s ease-in-out infinite;
    }
    @keyframes nyeFloat{
      0%,100%{ transform: translate(0,0) scale(1); }
      50%{ transform: translate(-1.8%, 1.4%) scale(1.03); }
    }
    .nyeLayer.fireworks{
      opacity:0.52;
      background:
        radial-gradient(circle at 18% 22%, transparent 0 34px, rgba(212,175,55,0.25) 35px 36px, transparent 37px 999px),
        radial-gradient(circle at 18% 22%, transparent 0 66px, rgba(255,255,255,0.12) 67px 68px, transparent 69px 999px),
        radial-gradient(circle at 78% 28%, transparent 0 30px, rgba(236,72,153,0.22) 31px 32px, transparent 33px 999px),
        radial-gradient(circle at 78% 28%, transparent 0 64px, rgba(255,255,255,0.10) 65px 66px, transparent 67px 999px),
        radial-gradient(circle at 58% 68%, transparent 0 34px, rgba(34,211,238,0.20) 35px 36px, transparent 37px 999px),
        radial-gradient(circle at 58% 68%, transparent 0 72px, rgba(255,255,255,0.10) 73px 74px, transparent 75px 999px);
      filter: blur(0.8px);
      animation: nyeBursts 4.6s ease-in-out infinite;
    }
    @keyframes nyeBursts{
      0%{ transform: scale(0.92) translateY(0); opacity:0.30; }
      35%{ transform: scale(1.04) translateY(-0.6%); opacity:0.70; }
      70%{ transform: scale(1.10) translateY(-1.2%); opacity:0.40; }
      100%{ transform: scale(0.92) translateY(0); opacity:0.30; }
    }
    .nyeLayer.confetti{
      opacity:0.33;
      background:
        repeating-linear-gradient(
          125deg,
          rgba(212,175,55,0.00) 0 24px,
          rgba(212,175,55,0.22) 24px 26px,
          rgba(236,72,153,0.18) 26px 28px,
          rgba(34,211,238,0.14) 28px 30px,
          rgba(255,255,255,0.10) 30px 31px,
          rgba(212,175,55,0.00) 31px 58px
        );
      filter: blur(0.4px);
      animation: nyeConfetti 9s linear infinite;
    }
    @keyframes nyeConfetti{
      0%{ transform: translate(-6%, -6%); }
      100%{ transform: translate(6%, 6%); }
    }
    .nyeVignette{
      position:absolute;
      inset:0;
      background:
        radial-gradient(circle at center, rgba(2,11,27,0.00) 0 40%, rgba(2,11,27,0.55) 75% 100%);
      opacity:0.95;
    }

    .stage::before{
      content:"";
      position:absolute;
      inset:-30%;
      z-index:1;
      background:
        radial-gradient(circle at 30% 20%, rgba(212,175,55,0.12), transparent 46%),
        radial-gradient(circle at 70% 60%, rgba(16,185,129,0.08), transparent 52%);
      animation: drift 10s ease-in-out infinite;
      pointer-events:none;
      mix-blend-mode: screen;
      opacity:0.9;
    }
    @keyframes drift{
      0%,100%{ transform: translate(0,0) rotate(0deg); }
      50%{ transform: translate(4%, -2%) rotate(2deg); }
    }

    @media (prefers-reduced-motion: reduce){
      .stage::before{ animation:none !important; }
      .nyeLayer{ animation:none !important; }
    }

    /* ====== UI layers above bg ====== */
    .topBar, .card, .legalFooter, .loadingOverlay, .finalOverlay{
      position:relative;
      z-index:2;
    }

    /* ====== TOP ====== */
    .topBar{
      display:flex;
      align-items:center;
      justify-content:center;
      padding:4px 6px 8px;
      flex:0 0 auto;
    }
    .mmLogo{
      width: min(220px, 66%);
      height:auto;
      object-fit:contain;
      display:block;
      filter: drop-shadow(0 12px 22px rgba(0,0,0,0.55));
      user-select:none;
      -webkit-user-drag:none;
      pointer-events:none;
    }
    .mmFallback{
      font-size:24px;
      font-weight:1000;
      color: var(--gold);
      letter-spacing:0.14em;
      text-shadow: 0 12px 24px rgba(0,0,0,0.55);
    }

    /* ====== CARD ====== */
    .card{
      background: linear-gradient(180deg, rgba(2,6,23,0.74), rgba(2,11,27,0.86));
      border-radius:18px;
      border:1px solid rgba(15,23,42,0.9);
      box-shadow: 0 18px 45px rgba(0,0,0,0.65);
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height:0;
      overflow:hidden;
    }

    /* ‚úÖ KEY FIX: allow the GAME card to scroll vertically if needed */
    #gameCard{
      flex: 1 1 auto;
      min-height: 0;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }

    /* ===== SHAKE ===== */
    .shake{ animation: shake 420ms ease-in-out; }
    @keyframes shake{
      0%,100%{ transform: translateX(0); }
      15%{ transform: translateX(-10px); }
      30%{ transform: translateX(10px); }
      45%{ transform: translateX(-8px); }
      60%{ transform: translateX(8px); }
      75%{ transform: translateX(-5px); }
      90%{ transform: translateX(5px); }
    }

    /* ===== LOCK ===== */
    .lockCenter{
      display:flex;
      flex-direction:column;
      gap:12px;
      padding:2px 2px 2px;
      position:relative;
      z-index:2;
    }

    .marquee{
      position:relative;
      border-radius:18px;
      padding:14px 12px 12px;
      border:1px solid rgba(212,175,55,0.32);
      background: linear-gradient(180deg, rgba(2,6,23,0.70), rgba(2,6,23,0.52));
      box-shadow: 0 18px 45px rgba(0,0,0,0.55);
      overflow:hidden;
      text-align:center;
      z-index:1;
    }
    .marquee::before{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius:20px;
      pointer-events:none;
      opacity:0.8;
      background:
        radial-gradient(circle at 8% 18%, rgba(212,175,55,0.95) 0 3px, transparent 4px),
        radial-gradient(circle at 18% 10%, rgba(212,175,55,0.95) 0 3px, transparent 4px),
        radial-gradient(circle at 30% 16%, rgba(212,175,55,0.95) 0 3px, transparent 4px),
        radial-gradient(circle at 70% 16%, rgba(212,175,55,0.95) 0 3px, transparent 4px),
        radial-gradient(circle at 82% 10%, rgba(212,175,55,0.95) 0 3px, transparent 4px),
        radial-gradient(circle at 92% 18%, rgba(212,175,55,0.95) 0 3px, transparent 4px),
        radial-gradient(circle at 12% 88%, rgba(212,175,55,0.95) 0 3px, transparent 4px),
        radial-gradient(circle at 24% 94%, rgba(212,175,55,0.95) 0 3px, transparent 4px),
        radial-gradient(circle at 36% 90%, rgba(212,175,55,0.95) 0 3px, transparent 4px),
        radial-gradient(circle at 64% 90%, rgba(212,175,55,0.95) 0 3px, transparent 4px),
        radial-gradient(circle at 76% 94%, rgba(212,175,55,0.95) 0 3px, transparent 4px),
        radial-gradient(circle at 88% 88%, rgba(212,175,55,0.95) 0 3px, transparent 4px);
      animation: bulbs 1.15s ease-in-out infinite;
      filter: drop-shadow(0 0 8px rgba(212,175,55,0.35));
      z-index:0;
    }
    .marquee > *{ position:relative; z-index:1; }
    @keyframes bulbs{ 0%,100%{ opacity:0.35; } 50%{ opacity:0.85; } }

    .lockTitle{
      text-align:center;
      font-size:16px;
      font-weight:1000;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color: var(--gold);
      margin:6px 0 0;
    }
    .lockSub{
      text-align:center;
      font-size:12px;
      color: rgba(229,231,235,0.88);
      line-height:1.45;
      margin:0;
    }

    .input{
      width:100%;
      border-radius:18px;
      border:1px solid rgba(212,175,55,0.35);
      background: rgba(2,6,23,0.70);
      padding:16px 16px;
      color:#e5e7eb;
      font-size:18px;
      letter-spacing:0.38em;
      outline:none;
      text-align:center;
      text-transform:uppercase;
      box-shadow: 0 12px 30px rgba(0,0,0,0.35);
    }
    .input::placeholder{
      font-size:12px;
      letter-spacing:0.16em;
      color:#64748b;
      text-transform:none;
    }
    .input:focus{
      border-color: rgba(212,175,55,0.75);
      box-shadow: 0 0 0 2px rgba(212,175,55,0.18), 0 12px 30px rgba(0,0,0,0.35);
    }

    .btn{
      width:100%;
      border-radius:18px;
      border:none;
      background: linear-gradient(180deg, #34d399, #10b981);
      color:#022c22;
      font-size:13px;
      font-weight:1000;
      padding:14px 14px;
      cursor:pointer;
      text-transform:uppercase;
      letter-spacing:0.18em;
      box-shadow: 0 14px 30px rgba(0,0,0,0.35);
    }
    .btn:active{ transform: scale(0.99); }
    .btn:disabled{ opacity:0.6; cursor:default; }

    .err{
      min-height:16px;
      text-align:center;
      font-size:11px;
      color: var(--danger);
      letter-spacing:0.04em;
    }

    /* ===== GAME META ===== */
    .metaRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius:999px;
      background: rgba(2,11,27,0.78);
      border:1px solid rgba(212,175,55,0.22);
      box-shadow: 0 10px 26px rgba(0,0,0,0.28);
    }
    .metaLeft{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .metaLabel{
      font-size:10px;
      letter-spacing:0.22em;
      text-transform:uppercase;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .metaValue{
      font-size:14px;
      font-weight:1000;
      letter-spacing:0.08em;
      color: var(--text);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      text-shadow: 0 10px 28px rgba(0,0,0,0.55);
    }

    .pill{
      font-size:10px;
      padding:6px 12px;
      border-radius:999px;
      border:1px solid rgba(212,175,55,0.55);
      background: rgba(10,25,47,0.9);
      color: var(--text);
      letter-spacing:0.14em;
      text-transform:uppercase;
      white-space:nowrap;
      flex:0 0 auto;
    }
    .pill.bad{ border-color: var(--danger); color:#fecaca; }
    .pill.good{ border-color: rgba(16,185,129,0.9); color:#a7f3d0; }

    /* ===== Timer ===== */
    .timerWrap{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(31,41,55,0.9);
      background: radial-gradient(circle at top, rgba(2,6,23,0.92), rgba(2,11,27,0.92));
      overflow:hidden;
    }
    .timerLeft{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .timerNum{
      font-size: clamp(36px, 10vw, 44px); /* ‚úÖ responsive */
      font-weight:1000;
      letter-spacing:0.06em;
      line-height:1;
      text-shadow: 0 10px 28px rgba(0,0,0,0.55);
      white-space:nowrap;
    }
    .timerNum.warn{ color: #FDE68A; }
    .timerNum.danger{
      color: #FCA5A5;
      animation: pulse 700ms ease-in-out infinite;
    }
    @keyframes pulse{
      0%,100%{ transform: scale(1); filter: brightness(1); }
      50%{ transform: scale(1.06); filter: brightness(1.25); }
    }
    .timerLabel{
      font-size:10px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color: var(--muted);
      white-space:nowrap;
    }
    .timerbar{
      flex:1 1 auto;
      height:10px;
      border-radius:999px;
      background: rgba(148,163,184,0.20);
      overflow:hidden;
      border:1px solid rgba(55,65,81,0.55);
    }
    .timerfill{
      height:100%;
      width:100%;
      background: linear-gradient(to right, var(--gold), #f9fafb);
      transform-origin:left center;
      transform: scaleX(1);
      transition: transform 0.1s linear;
    }

    /* ===== Question Box ===== */
    .questionBox{
      background: linear-gradient(180deg, rgba(2,6,23,0.68), rgba(2,6,23,0.50));
      border:1px solid rgba(55,65,81,0.8);
      border-radius:16px;
      padding:14px 14px;
      display:flex;
      flex-direction:column;
      gap:8px;
      position:relative;
      overflow:hidden;
    }
    .questionBox::before{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius:18px;
      pointer-events:none;
      opacity:0.55;
      background:
        radial-gradient(circle at 8% 20%, rgba(212,175,55,0.85) 0 3px, transparent 4px),
        radial-gradient(circle at 18% 12%, rgba(212,175,55,0.85) 0 3px, transparent 4px),
        radial-gradient(circle at 30% 18%, rgba(212,175,55,0.85) 0 3px, transparent 4px),
        radial-gradient(circle at 70% 18%, rgba(212,175,55,0.85) 0 3px, transparent 4px),
        radial-gradient(circle at 82% 12%, rgba(212,175,55,0.85) 0 3px, transparent 4px),
        radial-gradient(circle at 92% 20%, rgba(212,175,55,0.85) 0 3px, transparent 4px),
        radial-gradient(circle at 10% 86%, rgba(212,175,55,0.85) 0 3px, transparent 4px),
        radial-gradient(circle at 22% 92%, rgba(212,175,55,0.85) 0 3px, transparent 4px),
        radial-gradient(circle at 36% 88%, rgba(212,175,55,0.85) 0 3px, transparent 4px),
        radial-gradient(circle at 64% 88%, rgba(212,175,55,0.85) 0 3px, transparent 4px),
        radial-gradient(circle at 78% 92%, rgba(212,175,55,0.85) 0 3px, transparent 4px),
        radial-gradient(circle at 90% 86%, rgba(212,175,55,0.85) 0 3px, transparent 4px);
      animation: bulbs2 1.2s ease-in-out infinite;
      filter: drop-shadow(0 0 6px rgba(212,175,55,0.35));
    }
    @keyframes bulbs2{ 0%,100%{ opacity:0.35; } 50%{ opacity:0.75; } }
    .qMeta{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-width:0;
      position:relative;
      z-index:1;
    }
    .qLabel{
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color: var(--gold);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .qText{
      position:relative;
      z-index:1;
      font-size: clamp(15px, 4.6vw, 18px); /* ‚úÖ key fix */
      font-weight:1000;
      line-height:1.22;
      margin:0;
      word-break: break-word;
      overflow-wrap:anywhere;
    }

    /* ===== Answer Buttons (‚úÖ FIXED: no squares, no overlap) ===== */
    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: clamp(10px, 2.6vw, 12px);
      align-content:start;
      flex: 1 1 auto;
      min-height:0;
      padding-bottom: 2px;
    }

    .choiceBtn{
      width:100%;
      border-radius:18px;
      border:1px solid rgba(55,65,81,0.92);
      background: linear-gradient(180deg, rgba(2,6,23,0.82), rgba(2,6,23,0.68));
      padding: clamp(10px, 2.6vw, 14px);
      display:flex;
      align-items:flex-start;
      justify-content:flex-start;
      gap:12px;
      cursor:pointer;
      box-shadow: 0 10px 26px rgba(0,0,0,0.35);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      transition: transform 0.06s ease, filter 0.06s ease, border-color 0.12s ease;
      position:relative;
      overflow:hidden;
      touch-action: manipulation;

      /* ‚úÖ remove the square constraint that causes ‚Äústacking/clipping‚Äù on short screens */
      aspect-ratio: auto;
      min-height: 86px;
    }
    .choiceBtn::after{
      content:"";
      position:absolute;
      inset:0;
      background: radial-gradient(circle at 20% 10%, rgba(212,175,55,0.18), transparent 35%);
      opacity:0.65;
      pointer-events:none;
    }
    .choiceBtn:active{ transform: scale(0.985); filter: brightness(1.05); }
    .choiceBtn:disabled{ opacity:0.55; cursor:default; }

    .choiceKeyBig{
      width: clamp(44px, 12vw, 54px);
      height: clamp(44px, 12vw, 54px);
      border-radius:18px;
      display:flex;
      align-items:center;
      justify-content:center;
      border:1px solid rgba(212,175,55,0.55);
      background: rgba(10,25,47,0.85);
      color: var(--gold);
      font-weight:1000;
      font-size: clamp(18px, 5vw, 22px);
      letter-spacing:0.06em;
      box-shadow: inset 0 0 0 1px rgba(212,175,55,0.15);
      position:relative;
      z-index:1;
      flex:0 0 auto;
    }
    .choiceTxt{
      position:relative;
      z-index:1;
      font-size: clamp(12px, 3.8vw, 14px); /* ‚úÖ responsive */
      font-weight:900;
      line-height:1.18;
      color:#e5e7eb;
      opacity:0.98;
      min-width:0;
      flex:1 1 auto;
      word-break: break-word;
      overflow-wrap:anywhere;
    }

    /* ‚úÖ Ultra-short screens: switch to 1-column so nothing overlaps ever */
    @media (max-height: 650px){
      .grid{ grid-template-columns: 1fr; }
      .choiceBtn{ min-height: 72px; }
      .qText{ font-size: clamp(14px, 4.3vw, 16px); }
    }

    /* ===== Legal footer (always visible) ===== */
    .legalFooter{
      position:absolute;
      left:12px;
      right:12px;
      bottom:12px;
      display:flex;
      justify-content:center;
      pointer-events:none;
      z-index:6;
    }
    .legalFooter .inner{
      width:100%;
      max-width:520px;
      text-align:center;
      font-size:12px;
      color: rgba(156,163,175,0.95);
      letter-spacing:0.04em;
      line-height:1.35;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(212,175,55,0.22);
      background: rgba(2,11,27,0.42);
      backdrop-filter: blur(2px);
      box-shadow: 0 10px 26px rgba(0,0,0,0.28);
    }

    /* ‚úÖ KEY FIX: content scrolls within stage, footer stays visible */
    .content{
      display:flex;
      flex-direction:column;
      gap:10px;
      flex:1 1 auto;
      min-height:0;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 76px; /* reserve for footer */
    }

    /* ===== Loading overlay ===== */
    .loadingOverlay{
      position:absolute;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      gap:10px;
      z-index:20;
      background: radial-gradient(circle at center, rgba(2,11,27,0.35), rgba(2,11,27,0.80));
      backdrop-filter: blur(2px);
      padding:18px;
      text-align:center;
    }
    .loadingOverlay.show{ display:flex; }

    .loadingBadge{
      font-size:14px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color: var(--gold);
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(212,175,55,0.35);
      background: rgba(10,25,47,0.55);
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      max-width: 92%;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .typingDots{
      display:inline-flex;
      align-items:center;
      gap:6px;
      transform: translateY(1px);
    }
    .typingDots span{
      width:7px; height:7px; border-radius:999px;
      background: var(--gold);
      opacity:0.18;
      animation: typing 1.1s infinite ease-in-out;
    }
    .typingDots span:nth-child(2){ animation-delay: 0.18s; }
    .typingDots span:nth-child(3){ animation-delay: 0.36s; }
    @keyframes typing{
      0%{ opacity:0.18; transform: translateY(0) scale(0.95); }
      35%{ opacity:1; transform: translateY(-3px) scale(1.05); }
      70%{ opacity:0.24; transform: translateY(0) scale(1); }
      100%{ opacity:0.18; transform: translateY(0) scale(0.95); }
    }

    /* ===== FINAL OVERLAY ===== */
    .finalOverlay{
      position:absolute;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:50;
      background:
        radial-gradient(circle at 50% 30%, rgba(212,175,55,0.18), transparent 55%),
        radial-gradient(circle at 50% 60%, rgba(16,185,129,0.10), transparent 55%),
        rgba(2,11,27,0.75);
      backdrop-filter: blur(2px);
    }
    .finalOverlay.show{ display:flex; }

    .finalCard{
      width:100%;
      border-radius:22px;
      border:1px solid rgba(212,175,55,0.35);
      background: linear-gradient(180deg, rgba(2,6,23,0.78), rgba(2,11,27,0.88));
      box-shadow: 0 22px 60px rgba(0,0,0,0.70);
      padding:18px 16px 16px;
      text-align:center;
      position:relative;
      overflow:hidden;
      max-width:520px;
    }
    .finalLabel{
      position:relative;
      z-index:1;
      font-size:12px;
      letter-spacing:0.24em;
      text-transform:uppercase;
      color: var(--gold);
      margin:6px 0 6px;
    }
    .finalScoreBig{
      position:relative;
      z-index:1;
      font-size:84px;
      font-weight:1000;
      letter-spacing:0.06em;
      line-height:1;
      margin:6px 0 6px;
      color: #f9fafb;
      text-shadow: 0 22px 55px rgba(0,0,0,0.65);
    }
    .finalSub{
      position:relative;
      z-index:1;
      margin:0;
      font-size:14px;
      color: rgba(229,231,235,0.9);
      letter-spacing:0.04em;
    }
    .finalHint{
      position:relative;
      z-index:1;
      margin:10px 0 0;
      font-size:11px;
      color: rgba(156,163,175,0.95);
      letter-spacing:0.10em;
      text-transform:uppercase;
    }

    @media (max-width: 520px){
      .finalScoreBig{ font-size:72px; }
      .mmLogo{ width:min(220px, 70%); }
    }
  </style>
</head>

<body>
  <div class="stage">
    <!-- NYE Animated Background -->
    <div class="nyeBg" aria-hidden="true">
      <div class="nyeLayer sparkles"></div>
      <div class="nyeLayer bokeh"></div>
      <div class="nyeLayer fireworks"></div>
      <div class="nyeLayer confetti"></div>
      <div class="nyeVignette"></div>
    </div>

    <!-- Loading overlay between questions -->
    <div class="loadingOverlay" id="loadingOverlay" aria-live="polite">
      <div class="loadingBadge" id="loadingText">Cargando pr√≥xima pregunta</div>
      <div class="typingDots" aria-hidden="true">
        <span></span><span></span><span></span>
      </div>
    </div>

    <!-- Top logo always visible -->
    <div class="topBar">
      <img
        class="mmLogo"
        src="Assets/Logo_MM_Text.png"
        alt="Municipio de Mayag√ºez"
        draggable="false"
        onerror="this.remove(); this.parentNode.innerHTML='<div class=&quot;mmFallback&quot;>MAYAG√úEZ</div>';"
      />
    </div>

    <div class="content">
      <!-- LOCK -->
      <div class="card" id="lockCard">
        <div class="lockCenter">
          <div class="marquee">
            <h2 class="lockTitle">ENTRA EL C√ìDIGO</h2>
            <p class="lockSub">Escribe la contrase√±a y prep√°rate ‚Äî mira la pantalla grande.</p>
          </div>

          <input
            id="passkey"
            class="input"
            type="password"
            placeholder="CONTRASE√ëA"
            autocomplete="off"
            autocorrect="off"
            autocapitalize="off"
            spellcheck="false"
            inputmode="text"
          />

          <button id="enterBtn" class="btn">COMENZAR</button>
          <div id="err" class="err"></div>
        </div>
      </div>

      <!-- GAME -->
      <div class="card" id="gameCard" style="display:none;">
        <div class="metaRow">
          <div class="metaLeft">
            <div class="metaLabel" id="qLabel">ESPERANDO‚Ä¶</div>
            <div class="metaValue">Puntos: <span id="score">0</span></div>
          </div>
          <div id="livePill" class="pill good">EN VIVO</div>
        </div>

        <div class="timerWrap" aria-label="Tiempo">
          <div class="timerLeft">
            <div id="timerNum" class="timerNum">‚Äî</div>
            <div class="timerLabel">Tiempo</div>
          </div>
          <div class="timerbar"><div id="timerFill" class="timerfill"></div></div>
        </div>

        <div class="questionBox">
          <div class="qMeta">
            <div class="qLabel" id="qLabel2">PREGUNTA</div>
            <div class="pill" style="font-size:9px;padding:5px 10px;border-color:rgba(212,175,55,0.28);color:rgba(229,231,235,0.92);">TOCA UNA OPCI√ìN</div>
          </div>
          <p class="qText" id="qText">Mira la pantalla grande.</p>
        </div>

        <div class="grid">
          <button class="choiceBtn" id="btnA" aria-label="Respuesta A">
            <div class="choiceKeyBig">A</div>
            <div class="choiceTxt" id="txtA">‚Äî</div>
          </button>

          <button class="choiceBtn" id="btnB" aria-label="Respuesta B">
            <div class="choiceKeyBig">B</div>
            <div class="choiceTxt" id="txtB">‚Äî</div>
          </button>

          <button class="choiceBtn" id="btnC" aria-label="Respuesta C">
            <div class="choiceKeyBig">C</div>
            <div class="choiceTxt" id="txtC">‚Äî</div>
          </button>

          <button class="choiceBtn" id="btnD" aria-label="Respuesta D">
            <div class="choiceKeyBig">D</div>
            <div class="choiceTxt" id="txtD">‚Äî</div>
          </button>
        </div>
      </div>
    </div>

    <div class="legalFooter" aria-hidden="true">
      <div class="inner">
        LuminarApps ¬© 2025 ¬∑ Municipio de Mayag√ºez
      </div>
    </div>

    <div class="finalOverlay" id="finalOverlay" aria-live="polite">
      <div class="finalCard">
        <div class="finalLabel">PUNTUACI√ìN FINAL</div>
        <div class="finalScoreBig" id="finalScoreBig">0 / 20</div>
        <p class="finalSub" id="finalSub">Buen intento üî•</p>
        <p class="finalHint">Esperando al pr√≥ximo jugador‚Ä¶</p>
      </div>
    </div>
  </div>

  <script>
  /* ‚úÖ Hard-stop double-tap zoom quirks on some iOS Safari */
  document.addEventListener('dblclick', (e) => {
    e.preventDefault();
  }, { passive: false });

  /* ‚úÖ Optional: prevent multi-touch gesture zoom (iOS Safari) */
  document.addEventListener('gesturestart', (e) => e.preventDefault(), { passive:false });
  document.addEventListener('gesturechange', (e) => e.preventDefault(), { passive:false });
  document.addEventListener('gestureend', (e) => e.preventDefault(), { passive:false });

  /* ‚úÖ IMPORTANT FIX:
     DO NOT strip characters. Your passkey must be sent EXACTLY as typed. */
  const passkeyEl = document.getElementById("passkey");

  const ROOM_CODE = "ACTIVE";
  const QUESTION_SECONDS = 30;

  const lockCard = document.getElementById("lockCard");
  const gameCard = document.getElementById("gameCard");
  const enterBtn = document.getElementById("enterBtn");
  const errEl = document.getElementById("err");

  const scoreEl = document.getElementById("score");
  const qLabel = document.getElementById("qLabel");
  const qLabel2 = document.getElementById("qLabel2");
  const qText = document.getElementById("qText");

  const livePill = document.getElementById("livePill");

  const btnA = document.getElementById("btnA");
  const btnB = document.getElementById("btnB");
  const btnC = document.getElementById("btnC");
  const btnD = document.getElementById("btnD");

  const txtA = document.getElementById("txtA");
  const txtB = document.getElementById("txtB");
  const txtC = document.getElementById("txtC");
  const txtD = document.getElementById("txtD");

  const timerFill = document.getElementById("timerFill");
  const timerNum = document.getElementById("timerNum");

  const loadingOverlay = document.getElementById("loadingOverlay");
  const loadingText = document.getElementById("loadingText");

  const finalOverlay = document.getElementById("finalOverlay");
  const finalScoreBig = document.getElementById("finalScoreBig");
  const finalSub = document.getElementById("finalSub");

  const SESSION_ID_KEY = "trivia_controller_sessionId";
  const CTRL_TOKEN_KEY = "trivia_controller_token";

  function setLivePill(text, mode){
    livePill.textContent = text;
    livePill.classList.remove("bad","good");
    if (mode) livePill.classList.add(mode);
  }

  function showLoading(msg){
    loadingText.textContent = msg || "Cargando pr√≥xima pregunta";
    loadingOverlay.classList.add("show");
  }
  function hideLoading(){
    loadingOverlay.classList.remove("show");
  }

  function getOrMakeSessionId(){
    let sid = localStorage.getItem(SESSION_ID_KEY);
    if (!sid){
      sid = "sess_" + Math.random().toString(36).slice(2) + Date.now().toString(36);
      localStorage.setItem(SESSION_ID_KEY, sid);
    }
    return sid;
  }

  let sessionId = getOrMakeSessionId();
  let controllerToken = localStorage.getItem(CTRL_TOKEN_KEY) || "";

  let tickTimer = null;
  let lastState = null;
  let lockedAnswer = false;
  let lastQIndexSeen = -1;
  let shakenTimeoutForQ = -1;

  let pollerRunning = false;
  let pollerTimeout = null;

  function getStatePollMs(){
    if (lastState && (lastState.phase === "live" || lastState.phase === "feedback")) return 900;
    return 1300;
  }

  function disableChoices(disabled){
    [btnA,btnB,btnC,btnD].forEach(b => b.disabled = !!disabled);
  }

  function shakeGame(){
    gameCard.classList.remove("shake");
    void gameCard.offsetWidth;
    gameCard.classList.add("shake");
    setTimeout(()=> gameCard.classList.remove("shake"), 520);
  }

  function showFinalOverlay(score, total){
    finalScoreBig.textContent = `${score} / ${total}`;

    const pct = total > 0 ? (score/total) : 0;
    let msg = "Buen juego üî•";
    if (pct >= 0.9) msg = "¬°LEGENDARIO! üèÜ";
    else if (pct >= 0.7) msg = "¬°TREMENDO! üí™";
    else if (pct >= 0.4) msg = "Nada mal üòÑ";
    else msg = "¬°Pa‚Äô la pr√≥xima! üòé";
    finalSub.textContent = msg;

    finalOverlay.classList.add("show");
  }

  function hideFinalOverlay(){
    finalOverlay.classList.remove("show");
  }

  async function validateAndJoin(){
    const pk = passkeyEl.value.trim();

    if (!pk){
      errEl.textContent = "Escribe la contrase√±a para comenzar.";
      return;
    }
    errEl.textContent = "";
    enterBtn.disabled = true;

    try{
      const v = await fetch("/api/validate-passkey",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ passkey: pk })
      });
      const vd = await v.json().catch(()=> ({}));
      if (!v.ok || !vd.ok){
        throw new Error(vd.error || "invalid_passkey");
      }

      const j = await fetch("/api/join-room",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          roomCode: ROOM_CODE,
          passkey: pk,
          sessionId
        })
      });
      const jd = await j.json().catch(()=> ({}));
      if (!j.ok || !jd.ok){
        if (jd.error === "controller_taken") throw new Error("controller_taken");
        throw new Error(jd.error || "join_failed");
      }

      controllerToken = jd.controllerToken;
      localStorage.setItem(CTRL_TOKEN_KEY, controllerToken);

      try{
        await fetch("/api/answer",{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({
            roomCode: ROOM_CODE,
            controllerToken: jd.controllerToken,
            sessionId,
            choice: "__START__"
          })
        });
      }catch(_){}

      lockCard.style.display = "none";
      gameCard.style.display = "flex";
      hideFinalOverlay();

      passkeyEl.value = "";
      lockedAnswer = false;
      lastQIndexSeen = -1;
      shakenTimeoutForQ = -1;

      setLivePill("CONECTADO", "good");
      showLoading("Conectando‚Ä¶");

      startLoops();
    }catch(err){
      const code = String(err.message || err);
      if (code === "controller_taken"){
        errEl.textContent = "Otro tel√©fono ya est√° controlando este trivia.";
      } else {
        errEl.textContent = "Acceso denegado. Verifica la contrase√±a.";
      }
    }finally{
      enterBtn.disabled = false;
    }
  }

  enterBtn.addEventListener("click", validateAndJoin);
  passkeyEl.addEventListener("keydown",(e)=>{
    if (e.key === "Enter") validateAndJoin();
  });

  async function getState(){
    if (!controllerToken) return null;

    const r = await fetch("/api/get-state",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        roomCode: ROOM_CODE,
        controllerToken,
        sessionId
      })
    });

    const d = await r.json().catch(()=> ({}));

    if (!r.ok || !d.ok){
      if (d.errorCode === "controller_lost"){
        controllerToken = "";
        localStorage.removeItem(CTRL_TOKEN_KEY);
        stopLoops();
        hideFinalOverlay();
        hideLoading();

        lockCard.style.display = "flex";
        gameCard.style.display = "none";
        errEl.textContent = "Sesi√≥n terminada. El pr√≥ximo jugador puede comenzar.";
      }
      return null;
    }
    return d.state;
  }

  function renderFromState(st){
    lastState = st;

    const score = typeof st.score === "number" ? st.score : 0;
    const qIndex = typeof st.qIndex === "number" ? st.qIndex : 0;
    const total = typeof st.total === "number" ? st.total : 20;

    scoreEl.textContent = String(score);

    if (st.phase === "finished"){
      qLabel.textContent = "FINALIZADO";
      qLabel2.textContent = "FINALIZADO";
      qText.textContent = "El juego termin√≥ en la pantalla grande.";
      disableChoices(true);
      lockedAnswer = true;

      timerFill.style.transform = "scaleX(0)";
      timerNum.textContent = "‚Äî";
      timerNum.classList.remove("warn","danger");

      hideLoading();
      setLivePill("FINAL", "bad");
      showFinalOverlay(score, total);
      return;
    }

    hideFinalOverlay();

    if (st.phase === "splash"){
      qLabel.textContent = "CARGANDO‚Ä¶";
      qLabel2.textContent = "CARGANDO‚Ä¶";
      qText.textContent = "Mira la pantalla grande.";
      disableChoices(true);
      lockedAnswer = true;

      timerFill.style.transform = "scaleX(0)";
      timerNum.textContent = "‚Äî";
      timerNum.classList.remove("warn","danger");

      txtA.textContent = "‚Äî";
      txtB.textContent = "‚Äî";
      txtC.textContent = "‚Äî";
      txtD.textContent = "‚Äî";

      showLoading("Cargando pr√≥xima pregunta");
      setLivePill("CARGANDO", "bad");
      return;
    }

    hideLoading();
    setLivePill(st.phase === "feedback" ? "RESULTADO" : "EN VIVO", st.phase === "feedback" ? "bad" : "good");

    const n = Math.min(total, qIndex + 1);
    qLabel.textContent = `PREGUNTA ${n} / ${total}`;
    qLabel2.textContent = `PREGUNTA ${n} / ${total}`;
    qText.textContent = st.questionText || st.q || st.question || "Mira la pantalla grande.";

    if (st.answers){
      txtA.textContent = st.answers.A || "‚Äî";
      txtB.textContent = st.answers.B || "‚Äî";
      txtC.textContent = st.answers.C || "‚Äî";
      txtD.textContent = st.answers.D || "‚Äî";
    } else {
      txtA.textContent = "A";
      txtB.textContent = "B";
      txtC.textContent = "C";
      txtD.textContent = "D";
    }
  }

  async function sendAnswer(choice){
    if (!controllerToken || lockedAnswer) return;

    lockedAnswer = true;
    disableChoices(true);

    try{
      await fetch("/api/answer",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          roomCode: ROOM_CODE,
          controllerToken,
          sessionId,
          choice
        })
      });
    }catch(_){}
  }

  btnA.addEventListener("click", ()=> sendAnswer("A"));
  btnB.addEventListener("click", ()=> sendAnswer("B"));
  btnC.addEventListener("click", ()=> sendAnswer("C"));
  btnD.addEventListener("click", ()=> sendAnswer("D"));

  async function stateLoop(){
    const st = await getState();
    if (!st) return;

    if (st.phase === "live" && typeof st.qIndex === "number"){
      if (lastQIndexSeen !== st.qIndex){
        lastQIndexSeen = st.qIndex;
        lockedAnswer = false;
        disableChoices(false);
      }
    } else {
      lockedAnswer = true;
      disableChoices(true);
    }

    renderFromState(st);
  }

  function tick(){
    if (!lastState || lastState.phase !== "live" || !lastState.questionEndsAt){
      timerNum.textContent = "‚Äî";
      timerNum.classList.remove("warn","danger");
      timerFill.style.transform = "scaleX(0)";
      return;
    }

    const msLeft = lastState.questionEndsAt - Date.now();
    const sLeft = Math.max(0, Math.ceil(msLeft/1000));

    timerNum.textContent = String(sLeft);

    timerNum.classList.remove("warn","danger");
    if (sLeft <= 5) timerNum.classList.add("danger");
    else if (sLeft <= 15) timerNum.classList.add("warn");

    const pct = Math.max(0, Math.min(1, msLeft/(QUESTION_SECONDS*1000)));
    timerFill.style.transform = `scaleX(${pct})`;

    if (msLeft <= 0){
      disableChoices(true);
      const qIndex = typeof lastState.qIndex === "number" ? lastState.qIndex : -1;
      if (shakenTimeoutForQ !== qIndex){
        shakenTimeoutForQ = qIndex;
        gameCard.classList.remove("shake");
        void gameCard.offsetWidth;
        gameCard.classList.add("shake");
        setTimeout(()=> gameCard.classList.remove("shake"), 520);
      }
    }
  }

  async function pollerTick(){
    if (!pollerRunning) return;

    await stateLoop();
    pollerTimeout = setTimeout(pollerTick, getStatePollMs());
  }

  function startLoops(){
    stopLoops();

    pollerRunning = true;
    pollerTimeout = setTimeout(pollerTick, getStatePollMs());

    tickTimer = setInterval(tick, 100);
    stateLoop();
  }

  function stopLoops(){
    pollerRunning = false;

    if (pollerTimeout) clearTimeout(pollerTimeout);
    if (tickTimer) clearInterval(tickTimer);

    pollerTimeout = null;
    tickTimer = null;
  }

  (function bootstrap(){
    if (controllerToken){
      lockCard.style.display = "none";
      gameCard.style.display = "flex";
      setLivePill("REANUDANDO‚Ä¶", "good");
      showLoading("Reanudando‚Ä¶");
      startLoops();
    }
  })();
  </script>
</body>
</html>
